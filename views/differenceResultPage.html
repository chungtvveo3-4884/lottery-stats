<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center"><%= title %> </h1>
        <div class="mb-4">
            <a href="/" class="btn btn-primary">Quay lại trang chính</a>
        </div>
        <form id="paramForm" class="mb-4 mt-4" method="GET" action="/difference-sequences">
            <div class="row g-3">
                <div class="col-md-4"><label class="form-label">Ngày bắt đầu:</label><input type="date" class="form-control" name="startDate" value="<%= options.startDate %>"></div>
                <div class="col-md-4"><label class="form-label">Ngày kết thúc:</label><input type="date" class="form-control" name="endDate" value="<%= options.endDate %>"></div>
                <div class="col-md-4"><label class="form-label">Chế độ:</label><select class="form-select" name="mode"><option value="de" <%= options.mode === 'de' ? 'selected' : '' %>>Đề</option><option value="lo" <%= options.mode === 'lo' ? 'selected' : '' %>>Lô</option></select></div>
                <div class="col-md-4"><label class="form-label">Số ngày:</label><select class="form-select" name="consecutiveDays"><% for(let i=2; i<=20; i++) { %><option value="<%= i %>" <%= options.consecutiveDays==i ? 'selected' : '' %>><%= i %> ngày</option><% } %></select></div>
                <div class="col-md-4"><label class="form-label">Phân tích theo:</label><select class="form-select" name="analysisType"><option value="common_difference" <%= options.analysisType === 'common_difference' ? 'selected' : '' %>>Các số cùng hiệu</option><option value="difference_sequence" <%= options.analysisType === 'difference_sequence' ? 'selected' : '' %>>Chuỗi các hiệu</option></select></div>
                <div class="col-md-4"><label class="form-label">Tính chẵn/lẻ:</label><select class="form-select" name="diffParity" <%= options.analysisType !== 'difference_sequence' ? 'disabled' : '' %>><option value="any" <%= options.diffParity === 'any' ? 'selected' : '' %>>Bất kỳ</option><option value="even" <%= options.diffParity === 'even' ? 'selected' : '' %>>Chẵn</option><option value="odd" <%= options.diffParity === 'odd' ? 'selected' : '' %>>Lẻ</option></select></div>
                <div class="col-md-8"><label class="form-label">Kiểu chuỗi:</label><select class="form-select" name="pattern"><option value="consecutive_occurrence" <%= options.pattern === 'consecutive_occurrence' ? 'selected' : '' %>>Về liên tiếp</option><option value="monotonic_increasing" <%= options.pattern === 'monotonic_increasing' ? 'selected' : '' %>>Tăng dần</option><option value="monotonic_decreasing" <%= options.pattern === 'monotonic_decreasing' ? 'selected' : '' %>>Giảm dần</option><option value="arithmetic_increasing" <%= options.pattern === 'arithmetic_increasing' ? 'selected' : '' %>>Tăng dần ĐỀU</option><option value="arithmetic_decreasing" <%= options.pattern === 'arithmetic_decreasing' ? 'selected' : '' %>>Giảm dần ĐỀU</option></select></div>
                <div class="col-md-4 d-flex align-items-end"><button type="submit" class="btn btn-primary w-100">Thống kê lại</button></div>
            </div>
        </form>

        <% if (results && results.length > 0) { %>
            <p><b>Tổng số trường hợp: <%= total %></b>. <%= message %></p>
            <table class="table table-bordered table-striped">
                <thead class="table-dark">
                    <tr><th style="width: 25%;">Ngày</th><th style="width: 25%;">Chuỗi</th><th>Kết quả chi tiết</th></tr>
                </thead>
                <tbody>
                    <% results.forEach(result => { %>
                        <tr>
                            <td><%= formatDate(result.dates[0]) %> - <%= formatDate(result.dates[result.dates.length - 1]) %></td>
                            <td><span class="highlight fs-5"><%= result.sequence.map(n=>String(n).padStart(2,'0')).join(' → ') %></span></td>
                            <td>
                                <% result.results.forEach(day => { %>
                                    <div><small class="text-muted"><%= formatDate(day.date) %>:</small>
                                    <% day.numbers.forEach(num => { %>
                                        <% if (day.matched.includes(num)) { %><span class="highlight"><%= String(num).padStart(2, '0') %></span><% } else { %><span><%= String(num).padStart(2, '0') %></span><% } %>
                                    <% }) %></div>
                                <% }) %>
                            </td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        <% } else { %>
            <p class="text-center mt-4">Không tìm thấy kết quả nào.</p>
        <% } %>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.getElementById('endDate').addEventListener('change', function () {
            const endDateValue = this.value;
            if (endDateValue) {
                const endDate = new Date(endDateValue);
                const startDate = new Date(endDate);
                startDate.setDate(endDate.getDate() - 360);
                document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            }
        });
    </script>
</body>
</html>