<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thống kê Xổ số Miền Bắc</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        .nav-item .nav-link { font-weight: 500; color: #495057; background-color: #f8f9fa; border: 1px solid #dee2e6; margin-right: 5px; padding: 0.5rem 1rem; border-radius: 0.25rem; }
        .nav-item .nav-link:hover { color: #007bff; background-color: #e9ecef; }
        .nav-item .nav-link.active { color: #fff; background-color: #007bff; border-color: #007bff; font-weight: 600; }
        .loading-spinner { display: none; z-index: 1000; }
        .list-group-item h6 { font-size: 0.9rem; }
        .result-sequence { font-family: monospace; font-size: 1.1rem; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">Thống kê XSMB</h1>
        <div class="alert alert-info mt-4 mb-4">
            <p id="dataUpdateNote">Dữ liệu XSMB được cập nhật từ ngày 1/10/2005 đến ngày <span id="lastUpdateDate">AA/BB/CCCC</span></p>
            <button id="updateDataButton" class="btn btn-warning">Cập nhật dữ liệu</button>
        </div>
        
        <ul class="nav mb-4 justify-content-center" role="tablist">
            <li class="nav-item" role="presentation">
                <a class="nav-link active" href="/" role="tab">Thống kê</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" href="/scoring" role="tab">Tính điểm</a>
            </li>
             <li class="nav-item" role="presentation">
                <a class="nav-link" href="/simulation" role="tab">Giả Lập</a>
            </li>
        </ul>
        
        <form id="statForm" class="mb-4">
            <div class="row g-3 mb-3">
                <div class="col-md-4">
                    <label for="startDate" class="form-label">Ngày bắt đầu:</label>
                    <input type="date" class="form-control" id="startDate" name="startDate">
                </div>
                <div class="col-md-4">
                    <label for="endDate" class="form-label">Ngày kết thúc:</label>
                    <input type="date" class="form-control" id="endDate" name="endDate">
                </div>
                <div class="col-md-4">
                    <label for="mode" class="form-label">Chế độ:</label>
                    <select class="form-select" id="mode" name="mode">
                        <option value="de">Đề (Giải đặc biệt)</option>
                        <option value="lo">Lô (Tất cả các giải)</option>
                        <option value="prize1">Giải nhất</option>
                        <option value="prize2">Giải nhì</option>
                        <option value="prize3">Giải ba</option>
                        <option value="prize4">Giải tư</option>
                        <option value="prize5">Giải năm</option>
                        <option value="prize6">Giải sáu</option>
                        <option value="prize7">Giải bảy</option>
                        <option value="pos1">Vị trí 1 (Giải nhất)</option>
                        <option value="pos2">Vị trí 2 (Giải nhì 1)</option>
                        <option value="pos3">Vị trí 3 (Giải nhì 2)</option>
                        <option value="pos4">Vị trí 4 (Giải ba 1)</option>
                        <option value="pos5">Vị trí 5 (Giải ba 2)</option>
                        <option value="pos6">Vị trí 6 (Giải ba 3)</option>
                        <option value="pos7">Vị trí 7 (Giải ba 4)</option>
                        <option value="pos8">Vị trí 8 (Giải ba 5)</option>
                        <option value="pos9">Vị trí 9 (Giải ba 6)</option>
                        <option value="pos10">Vị trí 10 (Giải tư 1)</option>
                        <option value="pos11">Vị trí 11 (Giải tư 2)</option>
                        <option value="pos12">Vị trí 12 (Giải tư 3)</option>
                        <option value="pos13">Vị trí 13 (Giải tư 4)</option>
                        <option value="pos14">Vị trí 14 (Giải năm 1)</option>
                        <option value="pos15">Vị trí 15 (Giải năm 2)</option>
                        <option value="pos16">Vị trí 16 (Giải năm 3)</option>
                        <option value="pos17">Vị trí 17 (Giải năm 4)</option>
                        <option value="pos18">Vị trí 18 (Giải năm 5)</option>
                        <option value="pos19">Vị trí 19 (Giải năm 6)</option>
                        <option value="pos20">Vị trí 20 (Giải sáu 1)</option>
                        <option value="pos21">Vị trí 21 (Giải sáu 2)</option>
                        <option value="pos22">Vị trí 22 (Giải sáu 3)</option>
                        <option value="pos23">Vị trí 23 (Giải bảy 1)</option>
                        <option value="pos24">Vị trí 24 (Giải bảy 2)</option>
                        <option value="pos25">Vị trí 25 (Giải bảy 3)</option>
                        <option value="pos26">Vị trí 26 (Giải bảy 4)</option>
                    </select>
                </div>
            </div>
            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <label for="statFunction" class="form-label">Chức năng thống kê:</label>
                    <select class="form-select" id="statFunction" name="statFunction">
                        <optgroup label="--- Số ---">
                            <option value="/consecutive-pairs">Số về liên tiếp</option>
                            <option value="/consecutive-heads">1 đầu về liên tiếp</option>
                            <option value="/consecutive-tails">1 đít về liên tiếp</option>
                            <option value="/alternating-heads">Các đầu về so le liên tiếp</option>
                            <option value="/alternating-tails">Các đít về so le liên tiếp</option>
                            <option value="/alternating-number-pairs">Số về so le theo cặp</option>
                            <option value="/increasing-heads?pattern=monotonic">Các đầu số tiến liên tiếp</option>
                            <option value="/increasing-heads?pattern=arithmetic">Các đầu số tiến ĐỀU liên tiếp</option>
                            <option value="/decreasing-heads?pattern=monotonic">Các đầu số lùi liên tiếp</option>
                            <option value="/decreasing-heads?pattern=arithmetic">Các đầu số lùi ĐỀU liên tiếp</option>
                            <option value="/increasing-tails?pattern=monotonic">Các đít số tiến liên tiếp</option>
                             <option value="/increasing-tails?pattern=arithmetic">Các đít số tiến ĐỀU liên tiếp</option>
                            <option value="/decreasing-tails?pattern=monotonic">Các đít số lùi liên tiếp</option>
                            <option value="/decreasing-tails?pattern=arithmetic">Các đít số lùi ĐỀU liên tiếp</option>
                            <option value="/consecutive-increasing-numbers?pattern=monotonic">Các số tiến liên tiếp</option>
                            <option value="/consecutive-increasing-numbers?pattern=arithmetic">Các số tiến ĐỀU liên tiếp</option>
                            <option value="/consecutive-decreasing-numbers?pattern=monotonic">Các số lùi liên tiếp</option>     
                            <option value="/consecutive-decreasing-numbers?pattern=arithmetic">Các số lùi ĐỀU liên tiếp</option>
                            <option value="/parity-sequence-numbers?parityType=even-even&amp;pattern=monotonic_increasing">Số dạng Chẵn-Chẵn - Tiến dần</option>
                            <option value="/parity-sequence-numbers?parityType=even-even&amp;pattern=arithmetic_increasing">Số dạng Chẵn-Chẵn - Tiến dần ĐỀU</option>
                            <option value="/parity-sequence-numbers?parityType=even-even&amp;pattern=monotonic_decreasing">Số dạng Chẵn-Chẵn - Lùi dần</option>
                            <option value="/parity-sequence-numbers?parityType=even-even&amp;pattern=arithmetic_decreasing">Số dạng Chẵn-Chẵn - Lùi dần ĐỀU</option>
                            <option value="/parity-sequence-numbers?parityType=even-even&amp;pattern=consecutive_occurrence">Số dạng Chẵn-Chẵn - Về liên tiếp</option>
                            <option value="/parity-sequence-numbers?parityType=even-odd&amp;pattern=monotonic_increasing">Số dạng Chẵn-Lẻ - Tiến dần</option>
                            <option value="/parity-sequence-numbers?parityType=even-odd&amp;pattern=arithmetic_increasing">Số dạng Chẵn-Lẻ - Tiến dần ĐỀU</option>
                            <option value="/parity-sequence-numbers?parityType=even-odd&amp;pattern=monotonic_decreasing">Số dạng Chẵn-Lẻ - Lùi dần</option>
                            <option value="/parity-sequence-numbers?parityType=even-odd&amp;pattern=arithmetic_decreasing">Số dạng Chẵn-Lẻ - Lùi dần ĐỀU</option>
                            <option value="/parity-sequence-numbers?parityType=even-odd&amp;pattern=consecutive_occurrence">Số dạng Chẵn-Lẻ - Về liên tiếp</option>
                            <option value="/parity-sequence-numbers?parityType=odd-even&amp;pattern=monotonic_increasing">Số dạng Lẻ-Chẵn - Tiến dần</option>
                            <option value="/parity-sequence-numbers?parityType=odd-even&amp;pattern=arithmetic_increasing">Số dạng Lẻ-Chẵn - Tiến dần ĐỀU</option>
                            <option value="/parity-sequence-numbers?parityType=odd-even&amp;pattern=monotonic_decreasing">Số dạng Lẻ-Chẵn - Lùi dần</option>
                            <option value="/parity-sequence-numbers?parityType=odd-even&amp;pattern=arithmetic_decreasing">Số dạng Lẻ-Chẵn - Lùi dần ĐỀU</option>
                            <option value="/parity-sequence-numbers?parityType=odd-even&amp;pattern=consecutive_occurrence">Số dạng Lẻ-Chẵn - Về liên tiếp</option>
                            <option value="/parity-sequence-numbers?parityType=odd-odd&amp;pattern=monotonic_increasing">Số dạng Lẻ-Lẻ - Tiến dần</option>
                            <option value="/parity-sequence-numbers?parityType=odd-odd&amp;pattern=arithmetic_increasing">Số dạng Lẻ-Lẻ - Tiến dần ĐỀU</option>
                            <option value="/parity-sequence-numbers?parityType=odd-odd&amp;pattern=monotonic_decreasing">Số dạng Lẻ-Lẻ - Lùi dần</option>
                            <option value="/parity-sequence-numbers?parityType=odd-odd&amp;pattern=arithmetic_decreasing">Số dạng Lẻ-Lẻ - Lùi dần ĐỀU</option>
                            <option value="/parity-sequence-numbers?parityType=odd-odd&amp;pattern=consecutive_occurrence">Số dạng Lẻ-Lẻ - Về liên tiếp</option>
                            
                            <option value="/consecutive-double-numbers?pattern=consecutive_occurrence">[Số Kép] - Về liên tiếp</option>
                            <option value="/consecutive-double-numbers?pattern=monotonic_increasing">[Số Kép] - Tăng dần</option>
                            <option value="/consecutive-double-numbers?pattern=monotonic_decreasing">[Số Kép] - Giảm dần</option>
                            <option value="/consecutive-double-numbers?pattern=arithmetic_increasing">[Số Kép] - Tăng dần ĐỀU</option>
                            <option value="/consecutive-double-numbers?pattern=arithmetic_decreasing">[Số Kép] - Giảm dần ĐỀU</option>
                            <option value="/consecutive-offset-double-numbers?pattern=consecutive_occurrence">[Số Kép Lệch] - Về liên tiếp</option>
                            <option value="/consecutive-offset-double-numbers?pattern=monotonic_increasing">[Số Kép Lệch] - Tăng dần</option>
                            <option value="/consecutive-offset-double-numbers?pattern=monotonic_decreasing">[Số Kép Lệch] - Giảm dần</option>
                            <option value="/consecutive-offset-double-numbers?pattern=arithmetic_increasing">[Số Kép Lệch] - Tăng dần ĐỀU</option>
                            <option value="/consecutive-offset-double-numbers?pattern=arithmetic_decreasing">[Số Kép Lệch] - Giảm dần ĐỀU</option>
                            
                            <optgroup label="--- ĐẦU - ĐÍT ---">
                                <option value="/parity-head-tail-sequences?type=head&amp;parity=even&amp;pattern=monotonic_increasing">Đầu Chẵn - Tiến dần</option>
                                <option value="/parity-head-tail-sequences?type=head&amp;parity=even&amp;pattern=arithmetic_increasing">Đầu Chẵn - Tiến dần ĐỀU</option>
                                <option value="/parity-head-tail-sequences?type=head&amp;parity=even&amp;pattern=monotonic_decreasing">Đầu Chẵn - Lùi dần</option>
                                <option value="/parity-head-tail-sequences?type=head&amp;parity=even&amp;pattern=arithmetic_decreasing">Đầu Chẵn - Lùi dần ĐỀU</option>
                                <option value="/parity-head-tail-sequences?type=head&amp;parity=even&amp;pattern=consecutive_occurrence">Đầu Chẵn - Về liên tiếp</option>
                                <option value="/parity-head-tail-sequences?type=head&amp;parity=odd&amp;pattern=monotonic_increasing">Đầu Lẻ - Tiến dần</option>
                                <option value="/parity-head-tail-sequences?type=head&amp;parity=odd&amp;pattern=arithmetic_increasing">Đầu Lẻ - Tiến dần ĐỀU</option>
                                <option value="/parity-head-tail-sequences?type=head&amp;parity=odd&amp;pattern=monotonic_decreasing">Đầu Lẻ - Lùi dần</option>
                                <option value="/parity-head-tail-sequences?type=head&amp;parity=odd&amp;pattern=arithmetic_decreasing">Đầu Lẻ - Lùi dần ĐỀU</option>
                                <option value="/parity-head-tail-sequences?type=head&amp;parity=odd&amp;pattern=consecutive_occurrence">Đầu Lẻ - Về liên tiếp</option>
                                <option value="/parity-head-tail-sequences?type=tail&amp;parity=even&amp;pattern=monotonic_increasing">Đít Chẵn - Tiến dần</option>
                                <option value="/parity-head-tail-sequences?type=tail&amp;parity=even&amp;pattern=arithmetic_increasing">Đít Chẵn - Tiến dần ĐỀU</option>
                                <option value="/parity-head-tail-sequences?type=tail&amp;parity=even&amp;pattern=monotonic_decreasing">Đít Chẵn - Lùi dần</option>
                                <option value="/parity-head-tail-sequences?type=tail&amp;parity=even&amp;pattern=arithmetic_decreasing">Đít Chẵn - Lùi dần ĐỀU</option>
                                <option value="/parity-head-tail-sequences?type=tail&amp;parity=even&amp;pattern=consecutive_occurrence">Đít Chẵn - Về liên tiếp</option>
                                <option value="/parity-head-tail-sequences?type=tail&amp;parity=odd&amp;pattern=monotonic_increasing">Đít Lẻ - Tiến dần</option>
                                <option value="/parity-head-tail-sequences?type=tail&amp;parity=odd&amp;pattern=arithmetic_increasing">Đít Lẻ - Tiến dần ĐỀU</option>
                                <option value="/parity-head-tail-sequences?type=tail&amp;parity=odd&amp;pattern=monotonic_decreasing">Đít Lẻ - Lùi dần</option>
                                <option value="/parity-head-tail-sequences?type=tail&amp;parity=odd&amp;pattern=arithmetic_decreasing">Đít Lẻ - Lùi dần ĐỀU</option>
                                <option value="/parity-head-tail-sequences?type=tail&amp;parity=odd&amp;pattern=consecutive_occurrence">Đít Lẻ - Về liên tiếp</option>
                               
                                <option value="/head-tail-size-sequences?sizeType=big-big&amp;pattern=consecutive_occurrence">[Đầu To - Đít To] - Về liên tiếp</option>
                                <option value="/head-tail-size-sequences?sizeType=big-big&amp;pattern=monotonic_increasing">[Đầu To - Đít To] - Tăng dần</option>
                                <option value="/head-tail-size-sequences?sizeType=big-big&amp;pattern=monotonic_decreasing">[Đầu To - Đít To] - Giảm dần</option>
                                <option value="/head-tail-size-sequences?sizeType=big-big&amp;pattern=arithmetic_increasing">[Đầu To - Đít To] - Tăng dần ĐỀU</option>
                                <option value="/head-tail-size-sequences?sizeType=big-big&amp;pattern=arithmetic_decreasing">[Đầu To - Đít To] - Giảm dần ĐỀU</option>

                                <option value="/head-tail-size-sequences?sizeType=big-small&amp;pattern=consecutive_occurrence">[Đầu To - Đít Nhỏ] - Về liên tiếp</option>
                                <option value="/head-tail-size-sequences?sizeType=big-small&amp;pattern=monotonic_increasing">[Đầu To - Đít Nhỏ] - Tăng dần</option>
                                <option value="/head-tail-size-sequences?sizeType=big-small&amp;pattern=monotonic_decreasing">[Đầu To - Đít Nhỏ] - Giảm dần</option>
                                <option value="/head-tail-size-sequences?sizeType=big-small&amp;pattern=arithmetic_increasing">[Đầu To - Đít Nhỏ] - Tăng dần ĐỀU</option>
                                <option value="/head-tail-size-sequences?sizeType=big-small&amp;pattern=arithmetic_decreasing">[Đầu To - Đít Nhỏ] - Giảm dần ĐỀU</option>

                                <option value="/head-tail-size-sequences?sizeType=small-big&amp;pattern=consecutive_occurrence">[Đầu Nhỏ - Đít To] - Về liên tiếp</option>
                                <option value="/head-tail-size-sequences?sizeType=small-big&amp;pattern=monotonic_increasing">[Đầu Nhỏ - Đít To] - Tăng dần</option>
                                <option value="/head-tail-size-sequences?sizeType=small-big&amp;pattern=monotonic_decreasing">[Đầu Nhỏ - Đít To] - Giảm dần</option>
                                <option value="/head-tail-size-sequences?sizeType=small-big&amp;pattern=arithmetic_increasing">[Đầu Nhỏ - Đít To] - Tăng dần ĐỀU</option>
                                <option value="/head-tail-size-sequences?sizeType=small-big&amp;pattern=arithmetic_decreasing">[Đầu Nhỏ - Đít To] - Giảm dần ĐỀU</option>

                                <option value="/head-tail-size-sequences?sizeType=small-small&amp;pattern=consecutive_occurrence">[Đầu Nhỏ - Đít Nhỏ] - Về liên tiếp</option>
                                <option value="/head-tail-size-sequences?sizeType=small-small&amp;pattern=monotonic_increasing">[Đầu Nhỏ - Đít Nhỏ] - Tăng dần</option>
                                <option value="/head-tail-size-sequences?sizeType=small-small&amp;pattern=monotonic_decreasing">[Đầu Nhỏ - Đít Nhỏ] - Giảm dần</option>
                                <option value="/head-tail-size-sequences?sizeType=small-small&amp;pattern=arithmetic_increasing">[Đầu Nhỏ - Đít Nhỏ] - Tăng dần ĐỀU</option>
                                <option value="/head-tail-size-sequences?sizeType=small-small&amp;pattern=arithmetic_decreasing">[Đầu Nhỏ - Đít Nhỏ] - Giảm dần ĐỀU</option>

                                <option value="/even-heads-greater-than-4">Dạng đầu chẵn > 4 về liên tiếp</option>
                                <option value="/even-heads-less-than-4">Dạng đầu chẵn < 4 về liên tiếp</option>
                                <option value="/even-tails-greater-than-4">Dạng đít chẵn > 4 về liên tiếp</option>
                                <option value="/even-tails-less-than-4">Dạng đít chẵn < 4 về liên tiếp</option>
                                <option value="/odd-heads-greater-than-5">Dạng đầu lẻ > 5 về liên tiếp</option>
                                <option value="/odd-heads-less-than-5">Dạng đầu lẻ < 5 về liên tiếp</option>
                                <option value="/odd-tails-greater-than-5">Dạng đít lẻ > 5 về liên tiếp</option>
                                <option value="/odd-tails-less-than-5">Dạng đít lẻ < 5 về liên tiếp</option>
                                <option value="/head-and-tail-stats?n=0101">Dạng đầu chẵn > 4 và đít chẵn > 4 về liên tiếp</option>
                                <option value="/head-and-tail-stats?n=0100">Dạng đầu chẵn > 4 và đít chẵn < 4 về liên tiếp</option>
                                <option value="/head-and-tail-stats?n=0111">Dạng đầu chẵn > 4 và đít lẻ > 5 về liên tiếp</option>
                                <option value="/head-and-tail-stats?n=0110">Dạng đầu chẵn > 4 và đít lẻ < 5 về liên tiếp</option>
                                <option value="/head-and-tail-stats?n=0001">Dạng đầu chẵn < 4 và đít chẵn > 4 về liên tiếp</option>
                                <option value="/head-and-tail-stats?n=0000">Dạng đầu chẵn < 4 và đít chẵn < 4 về liên tiếp</option>
                                <option value="/head-and-tail-stats?n=0011">Dạng đầu chẵn < 4 và đít lẻ > 5 về liên tiếp</option>
                                <option value="/head-and-tail-stats?n=0010">Dạng đầu chẵn < 4 và đít lẻ < 5 về liên tiếp</option>
                                <option value="/head-and-tail-stats?n=1101">Dạng đầu lẻ > 5 và đít chẵn > 4 về liên tiếp</option>
                                <option value="/head-and-tail-stats?n=1100">Dạng đầu lẻ > 5 và đít chẵn < 4 về liên tiếp</option>
                                <option value="/head-and-tail-stats?n=1111">Dạng đầu lẻ > 5 và đít lẻ > 5 về liên tiếp</option>
                                <option value="/head-and-tail-stats?n=1110">Dạng đầu lẻ > 5 và đít lẻ < 5 về liên tiếp</option>
                                <option value="/head-and-tail-stats?n=1001">Dạng đầu lẻ < 5 và đít chẵn > 4 về liên tiếp</option>
                                <option value="/head-and-tail-stats?n=1000">Dạng đầu lẻ < 5 và đít chẵn < 4 về liên tiếp</option>
                                <option value="/head-and-tail-stats?n=1011">Dạng đầu lẻ < 5 và đít lẻ > 5 về liên tiếp</option>
                                <option value="/head-and-tail-stats?n=1010">Dạng đầu lẻ < 5 và đít lẻ < 5 về liên tiếp</option>
                                <option value="/head-and-tail-stats?n=401">Dạng đầu 4 và đít chẵn > 4 về liên tiếp</option>
                                <option value="/head-and-tail-stats?n=400">Dạng đầu 4 và đít chẵn < 4 về liên tiếp</option>
                                <option value="/head-and-tail-stats?n=411">Dạng đầu 4 và đít lẻ > 5 về liên tiếp</option>
                                <option value="/head-and-tail-stats?n=410">Dạng đầu 4 và đít lẻ < 5 về liên tiếp</option>
                                <option value="/head-and-tail-stats?n=501">Dạng đầu 5 và đít chẵn > 4 về liên tiếp</option>
                                <option value="/head-and-tail-stats?n=500">Dạng đầu 5 và đít chẵn < 4 về liên tiếp</option>
                                <option value="/head-and-tail-stats?n=511">Dạng đầu 5 và đít lẻ > 5 về liên tiếp</option>
                                <option value="/head-and-tail-stats?n=510">Dạng đầu 5 và đít lẻ < 5 về liên tiếp</option>
                                <option value="/head-and-tail-stats?n=014">Dạng đít 4 và đầu chẵn > 4 về liên tiếp</option>
                                <option value="/head-and-tail-stats?n=004">Dạng đít 4 và đầu chẵn < 4 về liên tiếp</option>
                                <option value="/head-and-tail-stats?n=114">Dạng đít 4 và đầu lẻ > 5 về liên tiếp</option>
                                <option value="/head-and-tail-stats?n=104">Dạng đít 4 và đầu lẻ < 5 về liên tiếp</option>
                                <option value="/head-and-tail-stats?n=015">Dạng đít 5 và đầu chẵn > 4 về liên tiếp</option>
                                <option value="/head-and-tail-stats?n=005">Dạng đít 5 và đầu chẵn < 4 về liên tiếp</option>
                                <option value="/head-and-tail-stats?n=115">Dạng đít 5 và đầu lẻ > 5 về liên tiếp</option>
                                <option value="/head-and-tail-stats?n=105">Dạng đít 5 và đầu lẻ < 5 về liên tiếp</option>
                            </optgroup>
                        </optgroup>    
                            <optgroup label="--- TỔNG TT, TỔNG MỚI ---">
                             <option value="/advanced-sequences?analysisType=common_sum_increasing&amp;sumType=traditional">[Tổng TT] Các số cùng tổng - Tăng dần</option>
                            <option value="/advanced-sequences?analysisType=common_sum_decreasing&amp;sumType=traditional">[Tổng TT] Các số cùng tổng - Giảm dần</option>
                            <option value="/advanced-sequences?analysisType=common_sum_arithmetic_increasing&amp;sumType=traditional">[Tổng TT] Các số cùng tổng - Tăng dần ĐỀU</option>
                            <option value="/advanced-sequences?analysisType=common_sum_arithmetic_decreasing&amp;sumType=traditional">[Tổng TT] Các số cùng tổng - Giảm dần ĐỀU</option>
                            <option value="/advanced-sequences?analysisType=common_sum_occurrence&amp;sumType=traditional">[Tổng TT] Các số cùng tổng - Về liên tiếp</option>

                            <option value="/advanced-sequences?analysisType=common_sum_increasing&amp;sumType=new">[Tổng Mới] Các số cùng tổng - Tăng dần</option>
                            <option value="/advanced-sequences?analysisType=common_sum_decreasing&amp;sumType=new">[Tổng Mới] Các số cùng tổng - Giảm dần</option>
                            <option value="/advanced-sequences?analysisType=common_sum_arithmetic_increasing&amp;sumType=new">[Tổng Mới] Các số cùng tổng - Tăng dần ĐỀU</option>
                            <option value="/advanced-sequences?analysisType=common_sum_arithmetic_decreasing&amp;sumType=new">[Tổng Mới] Các số cùng tổng - Giảm dần ĐỀU</option>
                            <option value="/advanced-sequences?analysisType=common_sum_occurrence&amp;sumType=new">[Tổng Mới] Các số cùng tổng - Về liên tiếp</option>
                            <option value="/advanced-sequences?analysisType=sum&amp;sumType=traditional&amp;pattern=monotonic_increasing">[Tổng TT] Các tổng - Tăng dần</option>
                            <option value="/advanced-sequences?analysisType=sum&amp;sumType=traditional&amp;pattern=monotonic_decreasing">[Tổng TT] Các tổng - Giảm dần</option>
                            <option value="/advanced-sequences?analysisType=sum&amp;sumType=traditional&amp;pattern=arithmetic_increasing">[Tổng TT] Các tổng - Tăng dần ĐỀU</option>
                            <option value="/advanced-sequences?analysisType=sum&amp;sumType=traditional&amp;pattern=arithmetic_decreasing">[Tổng TT] Các tổng - Giảm dần ĐỀU</option>
                            <option value="/advanced-sequences?analysisType=sum&amp;sumType=traditional&amp;pattern=consecutive_occurrence">[Tổng TT] Các tổng - Về liên tiếp</option>
                            <option value="/advanced-sequences?analysisType=sum&amp;sumType=new&amp;pattern=monotonic_increasing">[Tổng Mới] Các tổng - Tăng dần</option>
                            <option value="/advanced-sequences?analysisType=sum&amp;sumType=new&amp;pattern=monotonic_decreasing">[Tổng Mới] Các tổng - Giảm dần</option>
                            <option value="/advanced-sequences?analysisType=sum&amp;sumType=new&amp;pattern=arithmetic_increasing">[Tổng Mới] Các tổng - Tăng dần ĐỀU</option>
                            <option value="/advanced-sequences?analysisType=sum&amp;sumType=new&amp;pattern=arithmetic_decreasing">[Tổng Mới] Các tổng - Giảm dần ĐỀU</option>
                            <option value="/advanced-sequences?analysisType=sum&amp;sumType=new&amp;pattern=consecutive_occurrence">[Tổng Mới] Các tổng - Về liên tiếp</option>
                            <option value="/traditionalSumRangeSequences?sumRange=1-2">[Tổng TT] Thống kê tổng (1,2) về liên tiếp</option>
                            <option value="/traditionalSumRangeSequences?sumRange=3-4">[Tổng TT] Thống kê tổng (3,4) về liên tiếp</option>
                            <option value="/traditionalSumRangeSequences?sumRange=5-6">[Tổng TT] Thống kê tổng (5,6) về liên tiếp</option>
                            <option value="/traditionalSumRangeSequences?sumRange=7-8">[Tổng TT] Thống kê tổng (7,8) về liên tiếp </option>
                            <option value="/traditionalSumRangeSequences?sumRange=9-10">[Tổng TT] Thống kê tổng (9,10) về liên tiếp</option>
                            <option value="/specificSumRangeSequences?sumRange=0-3">[Tổng Mới] Thống kê tổng (0-3) về liên tiếp</option>
                            <option value="/specificSumRangeSequences?sumRange=4-6">[Tổng Mới] Thống kê tổng (4-6) về liên tiếp</option>
                            <option value="/specificSumRangeSequences?sumRange=7-9">[Tổng Mới] Thống kê tổng (7-9) về liên tiếp</option>
                            <option value="/specificSumRangeSequences?sumRange=10-12">[Tổng Mới] Thống kê tổng (10-12) về liên tiếp</option>
                            <option value="/specificSumRangeSequences?sumRange=13-15">[Tổng Mới] Thống kê tổng (13-15) về liên tiếp</option>
                            <option value="/specificSumRangeSequences?sumRange=16-18">[Tổng Mới] Thống kê tổng (16-18) về liên tiếp</option>
                            <option value="/soleSumSequences?sumType=traditional">[Tổng TT] Thống kê chuỗi tổng sole liên tiếp</option>
                            <option value="/soleSumSequences?sumType=new">[Tổng Mới] Thống kê chuỗi tổng sole liên tiếp</option>
                            <option value="/new-sum-sole-pairs">[Tổng Mới] Các tổng kiểu mới về sole theo cặp</option>
                        </optgroup>
                        <optgroup label="--- TỔNG CHẴN, LẺ (TRUYỀN THỐNG) ---">
                            <option value="/advanced-sequences?analysisType=sum&sumType=traditional&sumParity=even&pattern=monotonic_increasing">[Tổng TT] Tổng Chẵn - Tiến dần</option>
                            <option value="/advanced-sequences?analysisType=sum&sumType=traditional&sumParity=even&pattern=arithmetic_increasing">[Tổng TT] Tổng Chẵn - Tiến dần ĐỀU</option>
                            <option value="/advanced-sequences?analysisType=sum&sumType=traditional&sumParity=even&pattern=monotonic_decreasing">[Tổng TT] Tổng Chẵn - Lùi dần</option>
                            <option value="/advanced-sequences?analysisType=sum&sumType=traditional&sumParity=even&pattern=arithmetic_decreasing">[Tổng TT] Tổng Chẵn - Lùi dần ĐỀU</option>
                            <option value="/advanced-sequences?analysisType=sum&sumType=traditional&sumParity=even&pattern=consecutive_occurrence">[Tổng TT] Tổng Chẵn - Về liên tiếp</option>
                            <option value="/advanced-sequences?analysisType=sum&sumType=traditional&sumParity=odd&pattern=monotonic_increasing">[Tổng TT] Tổng Lẻ - Tiến dần</option>
                            <option value="/advanced-sequences?analysisType=sum&sumType=traditional&sumParity=odd&pattern=arithmetic_increasing">[Tổng TT] Tổng Lẻ - Tiến dần ĐỀU</option>
                            <option value="/advanced-sequences?analysisType=sum&sumType=traditional&sumParity=odd&pattern=monotonic_decreasing">[Tổng TT] Tổng Lẻ - Lùi dần</option>
                            <option value="/advanced-sequences?analysisType=sum&sumType=traditional&sumParity=odd&pattern=arithmetic_decreasing">[Tổng TT] Tổng Lẻ - Lùi dần ĐỀU</option>
                            <option value="/advanced-sequences?analysisType=sum&sumType=traditional&sumParity=odd&pattern=consecutive_occurrence">[Tổng TT] Tổng Lẻ - Về liên tiếp</option>
                        </optgroup>

                        <optgroup label="--- TỔNG CHẴN, LẺ (KIỂU MỚI) ---">
                            <option value="/advanced-sequences?analysisType=sum&sumType=new&sumParity=even&pattern=monotonic_increasing">[Tổng Mới]Tổng Chẵn - Tiến dần</option>
                            <option value="/advanced-sequences?analysisType=sum&sumType=new&sumParity=even&pattern=arithmetic_increasing">[Tổng Mới] Tổng Chẵn - Tiến dần ĐỀU</option>
                            <option value="/advanced-sequences?analysisType=sum&sumType=new&sumParity=even&pattern=monotonic_decreasing">[Tổng Mới] Tổng Chẵn - Lùi dần</option>
                            <option value="/advanced-sequences?analysisType=sum&sumType=new&sumParity=even&pattern=arithmetic_decreasing">[Tổng Mới] Tổng Chẵn - Lùi dần ĐỀU</option>
                            <option value="/advanced-sequences?analysisType=sum&sumType=new&sumParity=even&pattern=consecutive_occurrence">[Tổng Mới] Tổng Chẵn - Về liên tiếp</option>
                            <option value="/advanced-sequences?analysisType=sum&sumType=new&sumParity=odd&pattern=monotonic_increasing">[Tổng Mới] Tổng Lẻ - Tiến dần</option>
                            <option value="/advanced-sequences?analysisType=sum&sumType=new&sumParity=odd&pattern=arithmetic_increasing">[Tổng Mới] Tổng Lẻ - Tiến dần ĐỀU</option>
                            <option value="/advanced-sequences?analysisType=sum&sumType=new&sumParity=odd&pattern=monotonic_decreasing">[Tổng Mới] Tổng Lẻ - Lùi dần</option>
                            <option value="/advanced-sequences?analysisType=sum&sumType=new&sumParity=odd&pattern=arithmetic_decreasing">[Tổng Mới] Tổng Lẻ - Lùi dần ĐỀU</option>
                            <option value="/advanced-sequences?analysisType=sum&sumType=new&sumParity=odd&pattern=consecutive_occurrence">[Tổng Mới] Tổng Lẻ - Về liên tiếp</option>
                        </optgroup>
                        
                        <optgroup label="--- TỎNG DẠNG (0-18, KIỂU MỚI) ---">
                            <option value="/advanced-sequences?analysisType=sum_parity_pattern&amp;numberParity=even-even&amp;pattern=monotonic_increasing">[Tổng Mới] Tổng dạng Chẵn-Chẵn - Tiến dần</option>
                            <option value="/advanced-sequences?analysisType=sum_parity_pattern&amp;numberParity=even-even&amp;pattern=arithmetic_increasing">[Tổng Mới] Tổng dạng Chẵn-Chẵn - Tiến dần ĐỀU</option>
                            <option value="/advanced-sequences?analysisType=sum_parity_pattern&amp;numberParity=even-even&amp;pattern=monotonic_decreasing">[Tổng Mới] Tổng dạng Chẵn-Chẵn - Lùi dần</option>
                            <option value="/advanced-sequences?analysisType=sum_parity_pattern&amp;numberParity=even-even&amp;pattern=arithmetic_decreasing">[Tổng Mới] Tổng dạng Chẵn-Chẵn - Lùi dần ĐỀU</option>
                            <option value="/advanced-sequences?analysisType=sum_parity_pattern&amp;numberParity=even-even&amp;pattern=consecutive_occurrence">[Tổng Mới] Tổng dạng Chẵn-Chẵn - Về liên tiếp</option>
                            <option value="/advanced-sequences?analysisType=sum_parity_pattern&amp;numberParity=even-odd&amp;pattern=monotonic_increasing">[Tổng Mới] Tổng dạng Chẵn-Lẻ - Tiến dần</option>
                            <option value="/advanced-sequences?analysisType=sum_parity_pattern&amp;numberParity=even-odd&amp;pattern=arithmetic_increasing">[Tổng Mới] Tổng dạng Chẵn-Lẻ - Tiến dần ĐỀU</option>
                            <option value="/advanced-sequences?analysisType=sum_parity_pattern&amp;numberParity=even-odd&amp;pattern=monotonic_decreasing">[Tổng Mới] Tổng dạng Chẵn-Lẻ - Lùi dần</option>
                            <option value="/advanced-sequences?analysisType=sum_parity_pattern&amp;numberParity=even-odd&amp;pattern=arithmetic_decreasing">[Tổng Mới] Tổng dạng Chẵn-Lẻ - Lùi dần ĐỀU</option>
                            <option value="/advanced-sequences?analysisType=sum_parity_pattern&amp;numberParity=even-odd&amp;pattern=consecutive_occurrence">[Tổng Mới] Tổng dạng Chẵn-Lẻ - Về liên tiếp</option>
                            <option value="/advanced-sequences?analysisType=sum_parity_pattern&amp;numberParity=odd-even&amp;pattern=monotonic_increasing">[Tổng Mới] Tổng dạng Lẻ-Chẵn - Tiến dần</option>
                            <option value="/advanced-sequences?analysisType=sum_parity_pattern&amp;numberParity=odd-even&amp;pattern=arithmetic_increasing">[Tổng Mới] Tổng dạng Lẻ-Chẵn - Tiến dần ĐỀU</option>
                            <option value="/advanced-sequences?analysisType=sum_parity_pattern&amp;numberParity=odd-even&amp;pattern=monotonic_decreasing">[Tổng Mới] Tổng dạng Lẻ-Chẵn - Lùi dần</option>
                            <option value="/advanced-sequences?analysisType=sum_parity_pattern&amp;numberParity=odd-even&amp;pattern=arithmetic_decreasing">[Tổng Mới] Tổng dạng Lẻ-Chẵn - Lùi dần ĐỀU</option>
                            <option value="/advanced-sequences?analysisType=sum_parity_pattern&amp;numberParity=odd-even&amp;pattern=consecutive_occurrence">[Tổng Mới] Tổng dạng Lẻ-Chẵn - Về liên tiếp</option>
                            <option value="/advanced-sequences?analysisType=sum_parity_pattern&amp;numberParity=odd-odd&amp;pattern=monotonic_increasing">[Tổng Mới] Tổng dạng Lẻ-Lẻ - Tiến dần</option>
                            <option value="/advanced-sequences?analysisType=sum_parity_pattern&amp;numberParity=odd-odd&amp;pattern=arithmetic_increasing">[Tổng Mới] Tổng dạng Lẻ-Lẻ - Tiến dần ĐỀU</option>
                            <option value="/advanced-sequences?analysisType=sum_parity_pattern&amp;numberParity=odd-odd&amp;pattern=monotonic_decreasing">[Tổng Mới] Tổng dạng Lẻ-Lẻ - Lùi dần</option>
                            <option value="/advanced-sequences?analysisType=sum_parity_pattern&amp;numberParity=odd-odd&amp;pattern=arithmetic_decreasing">[Tổng Mới] Tổng dạng Lẻ-Lẻ - Lùi dần ĐỀU</option>
                            <option value="/advanced-sequences?analysisType=sum_parity_pattern&amp;numberParity=odd-odd&amp;pattern=consecutive_occurrence">[Tổng Mới] Tổng dạng Lẻ-Lẻ - Về liên tiếp</option>
                        </optgroup>
                        
                        <optgroup label="--- TỔNG DẠNG (1-10, TRUYỀN THỐNG) ---">
                            <option value="/advanced-sequences?analysisType=sum_parity_pattern&amp;sumType=traditional&amp;numberParity=even-even&amp;pattern=monotonic_increasing">[Tổng TT] Tổng dạng Chẵn-Chẵn - Tiến dần</option>
                            <option value="/advanced-sequences?analysisType=sum_parity_pattern&amp;sumType=traditional&amp;numberParity=even-even&amp;pattern=arithmetic_increasing">[Tổng TT] Tổng dạng Chẵn-Chẵn - Tiến dần ĐỀU</option>
                            <option value="/advanced-sequences?analysisType=sum_parity_pattern&amp;sumType=traditional&amp;numberParity=even-even&amp;pattern=monotonic_decreasing">[Tổng TT] Tổng dạng Chẵn-Chẵn - Lùi dần</option>
                            <option value="/advanced-sequences?analysisType=sum_parity_pattern&amp;sumType=traditional&amp;numberParity=even-even&amp;pattern=arithmetic_decreasing">[Tổng TT] Tổng dạng Chẵn-Chẵn - Lùi dần ĐỀU</option>
                            <option value="/advanced-sequences?analysisType=sum_parity_pattern&amp;sumType=traditional&amp;numberParity=even-even&amp;pattern=consecutive_occurrence">[Tổng TT] Tổng dạng Chẵn-Chẵn - Về liên tiếp</option>
                            <option value="/advanced-sequences?analysisType=sum_parity_pattern&amp;sumType=traditional&amp;numberParity=even-odd&amp;pattern=monotonic_increasing">[Tổng TT] Tổng dạng Chẵn-Lẻ - Tiến dần</option>
                            <option value="/advanced-sequences?analysisType=sum_parity_pattern&amp;sumType=traditional&amp;numberParity=even-odd&amp;pattern=arithmetic_increasing">[Tổng TT] Tổng dạng Chẵn-Lẻ - Tiến dần ĐỀU</option>
                            <option value="/advanced-sequences?analysisType=sum_parity_pattern&amp;sumType=traditional&amp;numberParity=even-odd&amp;pattern=monotonic_decreasing">[Tổng TT] Tổng dạng Chẵn-Lẻ - Lùi dần</option>
                            <option value="/advanced-sequences?analysisType=sum_parity_pattern&amp;sumType=traditional&amp;numberParity=even-odd&amp;pattern=arithmetic_decreasing">[Tổng TT] Tổng dạng Chẵn-Lẻ - Lùi dần ĐỀU</option>
                            <option value="/advanced-sequences?analysisType=sum_parity_pattern&amp;sumType=traditional&amp;numberParity=even-odd&amp;pattern=consecutive_occurrence">[Tổng TT] Tổng dạng Chẵn-Lẻ - Về liên tiếp</option>
                        </optgroup>
                        <optgroup label="--- THỐNG KÊ HIỆU (ĐẦU - ĐÍT) ---">
                            <option value="/difference-sequences?analysisType=common_difference&amp;pattern=consecutive_occurrence">[Cùng Hiệu] Các số - Về liên tiếp</option>
                            <option value="/difference-sequences?analysisType=common_difference&amp;pattern=monotonic_increasing">[Cùng Hiệu] Các số - Tăng dần</option>
                            <option value="/difference-sequences?analysisType=common_difference&amp;pattern=monotonic_decreasing">[Cùng Hiệu] Các số - Giảm dần</option>
                            <option value="/difference-sequences?analysisType=common_difference&amp;pattern=arithmetic_increasing">[Cùng Hiệu] Các số - Tăng dần ĐỀU</option>
                            <option value="/difference-sequences?analysisType=common_difference&amp;pattern=arithmetic_decreasing">[Cùng Hiệu] Các số - Giảm dần ĐỀU</option>
                            <option value="/difference-sequences?analysisType=difference_sequence&amp;diffParity=any&amp;pattern=monotonic_increasing">[Các Hiệu] - Tăng dần</option>
                            <option value="/difference-sequences?analysisType=difference_sequence&amp;diffParity=any&amp;pattern=monotonic_decreasing">[Các Hiệu] - Giảm dần</option>
                            <option value="/difference-sequences?analysisType=difference_sequence&amp;diffParity=any&amp;pattern=arithmetic_increasing">[Các Hiệu] - Tăng dần ĐỀU</option>
                            <option value="/difference-sequences?analysisType=difference_sequence&amp;diffParity=any&amp;pattern=arithmetic_decreasing">[Các Hiệu] - Giảm dần ĐỀU</option>
                            <option value="/difference-sequences?analysisType=difference_sequence&amp;diffParity=even&amp;pattern=consecutive_occurrence">[Hiệu Chẵn] - Về liên tiếp</option>
                            <option value="/difference-sequences?analysisType=difference_sequence&amp;diffParity=even&amp;pattern=monotonic_increasing">[Hiệu Chẵn] - Tăng dần</option>
                            <option value="/difference-sequences?analysisType=difference_sequence&amp;diffParity=even&amp;pattern=monotonic_decreasing">[Hiệu Chẵn] - Giảm dần</option>
                            <option value="/difference-sequences?analysisType=difference_sequence&amp;diffParity=even&amp;pattern=arithmetic_increasing">[Hiệu Chẵn] - Tăng dần ĐỀU</option>
                            <option value="/difference-sequences?analysisType=difference_sequence&amp;diffParity=even&amp;pattern=arithmetic_decreasing">[Hiệu Chẵn] - Giảm dần ĐỀU</option>
                            <option value="/difference-sequences?analysisType=difference_sequence&amp;diffParity=odd&amp;pattern=consecutive_occurrence">[Hiệu Lẻ] - Về liên tiếp</option>
                            <option value="/difference-sequences?analysisType=difference_sequence&amp;diffParity=odd&amp;pattern=monotonic_increasing">[Hiệu Lẻ] - Tăng dần</option>
                            <option value="/difference-sequences?analysisType=difference_sequence&amp;diffParity=odd&amp;pattern=monotonic_decreasing">[Hiệu Lẻ] - Giảm dần</option>
                            <option value="/difference-sequences?analysisType=difference_sequence&amp;diffParity=odd&amp;pattern=arithmetic_increasing">[Hiệu Lẻ] - Tăng dần ĐỀU</option>
                            <option value="/difference-sequences?analysisType=difference_sequence&amp;diffParity=odd&amp;pattern=arithmetic_decreasing">[Hiệu Lẻ] - Giảm dần ĐỀU</option>
                        </optgroup>
                    </select>
                
                </div>
                <div class="col-md-6">
                    <label for="consecutiveDays" class="form-label">Số ngày về liên tiếp:</label>
                    <select class="form-select" id="consecutiveDays" name="consecutiveDays">
                        <option value="2">2 ngày</option>
                        <option value="3">3 ngày</option>
                        <option value="4">4 ngày</option>
                        <option value="5">5 ngày</option>
                        <option value="6">6 ngày</option>
                        <option value="7">7 ngày</option>
                        <option value="8">8 ngày</option>
                        <option value="9">9 ngày</option>
                        <option value="10">10 ngày</option>
                        <option value="11">11 ngày</option>
                        <option value="12">12 ngày</option>
                        <option value="13">13 ngày</option>
                        <option value="14">14 ngày</option>
                        <option value="15">15 ngày</option>
                        <option value="16">16 ngày</option>
                        <option value="17">17 ngày</option>
                        <option value="18">18 ngày</option>
                        <option value="19">19 ngày</option>
                        <option value="20">20 ngày</option>
                    </select>        
                </div>
            </div> 
            <div class="row g-3 mt-3">
                <button type="submit" class="btn btn-primary">Thống kê</button>
            </div>   
        </form>

        <hr class="my-5">

        <div id="overall-stats-section">
            <h2 class="text-center mb-4">Thống kê Tổng hợp Nhanh</h2>
            <div id="loading-spinner" class="loading-spinner text-center my-4">
                 <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Đang tải...</span></div>
            </div>
            <div id="error-message" class="alert alert-danger" style="display: none;"></div>
            <div id="dashboard-content" style="display: none;">
                <!-- Phần Phân tích chuỗi nóng -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">Phân tích Chuỗi nóng (Kết thúc ngày <span id="latest-date-overall"></span>)</h4>
                    </div>
                    <div class="card-body">
                        <p>Các dạng thống kê đang xuất hiện trong các ngày gần nhất (chỉ xét Đề):</p>
                        <div class="accordion" id="recent-streaks-accordion"></div>
                        <div id="no-streaks-message" class="alert alert-secondary mt-3" style="display: none;">
                            Không có chuỗi nóng nào đang chạy trong các ngày gần đây.
                        </div>
                    </div>
                </div>

                <!-- Phần Bảng kỷ lục (giữ nguyên cấu trúc) -->
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h4 class="mb-0">Chuỗi về liên tiếp dài nhất (Chỉ xét Đề)</h4>
                    </div>
                    <div class="card-body">
                         <div class="table-responsive">
                            <table class="table table-striped table-bordered table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th style="width: 20%;">Loại Thống Kê</th>
                                        <th style="width: 40%;">Chuỗi Kỷ Lục</th>
                                        <th style="width: 40%;">Chuỗi Dài Thứ 2</th>
                                    </tr>
                                </thead>
                                <tbody id="longest-run-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/dashboardRenderers.js"></script>
    <script>
        document.getElementById('statForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const mode = document.getElementById('mode').value;
            const statFunction = document.getElementById('statFunction').value;
            const consecutiveDays = document.getElementById('consecutiveDays').value;
            const [baseUrl, queryString] = statFunction.split('?');
            let newUrl;
            if (queryString) {
                const params = new URLSearchParams(queryString);
                const n = params.get('n');
                const order = params.get('order');
                const parityType = params.get('parityType');
                const sumType = params.get('sumType');
                const sequenceType = params.get('sequenceType');
                const pattern = params.get('pattern');
                const sumRange = params.get('sumRange');
                const analysisType = params.get('analysisType');
                if (n) {
                    newUrl = `${baseUrl}?n=${n}&startDate=${startDate}&endDate=${endDate}&mode=${mode}&consecutiveDays=${consecutiveDays}`;
                } else if (analysisType) {
                    newUrl = `${baseUrl}?${queryString}&startDate=${startDate}&endDate=${endDate}&mode=${mode}&consecutiveDays=${consecutiveDays}`;
                } else if (parityType && order) {
                    newUrl = `${baseUrl}?parityType=${parityType}&order=${order}&startDate=${startDate}&endDate=${endDate}&mode=${mode}&consecutiveDays=${consecutiveDays}`;
                } else if (sumType && sequenceType && pattern) {
                    newUrl = `${baseUrl}?sumType=${sumType}&sequenceType=${sequenceType}&pattern=${pattern}&startDate=${startDate}&endDate=${endDate}&mode=${mode}&consecutiveDays=${consecutiveDays}`;
                } else if (sumType && order) {
                    newUrl = `${baseUrl}?sumType=${sumType}&order=${order}&startDate=${startDate}&endDate=${endDate}&mode=${mode}&consecutiveDays=${consecutiveDays}`;
                } else if (sumType) {
                    newUrl = `${baseUrl}?sumType=${sumType}&startDate=${startDate}&endDate=${endDate}&mode=${mode}&consecutiveDays=${consecutiveDays}`;  
                } else if (order) {
                    newUrl = `${baseUrl}?order=${order}&startDate=${startDate}&endDate=${endDate}&mode=${mode}&consecutiveDays=${consecutiveDays}`;
                } else if (sumRange) {
                    newUrl = `${baseUrl}?sumRange=${sumRange}&startDate=${startDate}&endDate=${endDate}&mode=${mode}&consecutiveDays=${consecutiveDays}`;
                } else {
                    newUrl = `${baseUrl}?${queryString}&startDate=${startDate}&endDate=${endDate}&mode=${mode}&consecutiveDays=${consecutiveDays}`;
                }
            } else {
                newUrl = `${baseUrl}?startDate=${startDate}&endDate=${endDate}&mode=${mode}&consecutiveDays=${consecutiveDays}`;
            }
            window.location.href = newUrl;
        });

        function formatDate(dateString) {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        document.getElementById('endDate').addEventListener('change', function () {
            const endDateValue = this.value;
            if (endDateValue) {
                const endDate = new Date(endDateValue);
                const startDate = new Date(endDate);
                startDate.setDate(endDate.getDate() - 360);
                const today = new Date();
                const todayFormatted = today.toISOString().split('T')[0];
                const startDateFormatted = startDate.toISOString().split('T')[0];
                document.getElementById('startDate').value = startDateFormatted;
                if (startDate > today) {
                    document.getElementById('startDate').value = todayFormatted;
                }
            }
        });

        document.getElementById('statFunction').addEventListener('change', function () {
            const consecutiveDaysDropdown = document.getElementById('consecutiveDays');
            const selectedOption = this.value;

            const limitedTo5DaysFunctions = [
                '/odd-consecutive-heads',
                '/odd-consecutive-tails',
                '/odd-decreasing-heads',
                '/odd-decreasing-tails',
                '/even-increasing-heads',
                '/even-increasing-tails',
                '/even-decreasing-heads',
                '/even-decreasing-tails'
            ];

            const limitedTo10DaysFunctions = [
                '/increasing-heads',
                '/decreasing-heads',
                '/increasing-tails',
                '/decreasing-tails',
                '/consecutive-sum-increasing-numbers',
                '/consecutive-sum-decreasing-numbers',
                '/consecutive-sum-sequences?order=asc',
                '/consecutive-sum-sequences?order=desc'
            ];

            consecutiveDaysDropdown.innerHTML = '';

            if (limitedTo5DaysFunctions.includes(selectedOption)) {
                for (let i = 2; i <= 5; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i} ngày`;
                    consecutiveDaysDropdown.appendChild(option);
                }
            } else if (limitedTo10DaysFunctions.includes(selectedOption)) {
                for (let i = 2; i <= 10; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i} ngày`;
                    consecutiveDaysDropdown.appendChild(option);
                }
            } else if (selectedOption === '/alternating-heads' || selectedOption === '/alternating-tails' || selectedOption ==='/alternating-number-pairs' || selectedOption === '/soleSumSequences?sumType=traditional' || selectedOption === '/soleSumSequences?sumType=new') {
                for (let i = 3; i <= 20; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i} ngày`;
                    consecutiveDaysDropdown.appendChild(option);
                }
            } else {
                for (let i = 2; i <= 20; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i} ngày`;
                    consecutiveDaysDropdown.appendChild(option);
                }
            }
        });

        function updateLastUpdateDate() {
            fetch('/api/last-update-date')
                .then(response => response.json())
                .then(data => {
                    const lastUpdateDateElement = document.getElementById('lastUpdateDate');
                    if (data.lastUpdateDate) {
                        const formattedDate = formatDate(data.lastUpdateDate);
                        lastUpdateDateElement.textContent = formattedDate;
                    } else {
                        lastUpdateDateElement.textContent = 'Không có dữ liệu';
                    }
                })
                .catch(error => {
                    console.error('Lỗi khi lấy ngày cập nhật:', error);
                });
        }
        
        // Listener này sẽ chạy các logic cũ của bạn
        document.addEventListener('DOMContentLoaded', function() {
            updateLastUpdateDate();
            document.getElementById('updateDataButton').addEventListener('click', function () {
                updateData();
            });

            const today = new Date().toISOString().split('T')[0];
            const defaultStartDate = new Date();
            defaultStartDate.setDate(defaultStartDate.getDate() - 360);
            const formattedStartDate = defaultStartDate.toISOString().split('T')[0];
            document.getElementById('startDate').value = formattedStartDate;
            document.getElementById('endDate').value = today;

            // Set active tab based on current path
            const currentPath = window.location.pathname;
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === currentPath) {
                    link.classList.add('active');
                }
            });
        });
    </script>

    <script>
        const statDisplayNames = {
            'consecutivePairs': '[Số] về liên tiếp',
            'consecutiveHeads': '[Đầu] về liên tiếp',
            'consecutiveTails': '[Đít] về liên tiếp',
            'alternatingNumberPairs': '[Số] về so le theo cặp',
            'alternatingHeads': '[Đầu] Các đầu về so le liên tiếp',
            'alternatingTails': '[Đít] Các đít về so le liên tiếp',
            'head_inc_mono': '[Đầu] Tiến dần',
            'head_inc_arith': '[Đầu] Tiến dần ĐỀU',
            'head_dec_mono': '[Đầu] Lùi dần',
            'head_dec_arith': '[Đầu] Lùi dần ĐỀU',
            'tail_inc_mono': '[Đít] Tiến dần',
            'tail_inc_arith': '[Đít] Tiến dần ĐỀU',
            'tail_dec_mono': '[Đít] Lùi dần',
            'tail_dec_arith': '[Đít] Lùi dần ĐỀU',
            'consecutive_inc_mono': '[Số] Tiến dần',
            'consecutive_inc_arith': '[Số] Tiến dần ĐỀU',
            'consecutive_dec_mono': '[Số] Lùi dần',      
            'consecutive_dec_arith': '[Số] Lùi dần ĐỀU',
            // --- Dạng Chẵn-Chẵn ---
            'numpar_ee_mono_inc': '[Số] Chẵn-Chẵn - Tiến dần',
            'numpar_ee_arith_inc': '[Số] Chẵn-Chẵn - Tiến dần ĐỀU',
            'numpar_ee_mono_dec': '[Số] Chẵn-Chẵn - Lùi dần',
            'numpar_ee_arith_dec': '[Số] Chẵn-Chẵn - Lùi dần ĐỀU',
            'numpar_ee_occur': '[Số] Chẵn-Chẵn - Về liên tiếp',

            // --- Dạng Chẵn-Lẻ ---
            'numpar_eo_mono_inc': '[Số] Chẵn-Lẻ - Tiến dần',
            'numpar_eo_arith_inc': '[Số] Chẵn-Lẻ - Tiến dần ĐỀU',
            'numpar_eo_mono_dec': '[Số] Chẵn-Lẻ - Lùi dần',
            'numpar_eo_arith_dec': '[Số] Chẵn-Lẻ - Lùi dần ĐỀU',
            'numpar_eo_occur': '[Số] Chẵn-Lẻ - Về liên tiếp',

            // --- Dạng Lẻ-Chẵn ---
            'numpar_oe_mono_inc': '[Số] Lẻ-Chẵn - Tiến dần',
            'numpar_oe_arith_inc': '[Số] Lẻ-Chẵn - Tiến dần ĐỀU',
            'numpar_oe_mono_dec': '[Số] Lẻ-Chẵn - Lùi dần',
            'numpar_oe_arith_dec': '[Số] Lẻ-Chẵn - Lùi dần ĐỀU',
            'numpar_oe_occur': '[Số] Lẻ-Chẵn - Về liên tiếp',

            // --- Dạng Lẻ-Lẻ ---
            'numpar_oo_mono_inc': '[Số] Lẻ-Lẻ - Tiến dần',
            'numpar_oo_arith_inc': '[Số] Lẻ-Lẻ - Tiến dần ĐỀU',
            'numpar_oo_mono_dec': '[Số] Lẻ-Lẻ - Lùi dần',
            'numpar_oo_arith_dec': '[Số] Lẻ-Lẻ - Lùi dần ĐỀU',
            'numpar_oo_occur': '[Số] Lẻ-Lẻ - Về liên tiếp',
            
            'double_occur': '[Số Kép] Về liên tiếp',
            'double_mono_inc': '[Số Kép] Tăng dần',
            'double_mono_dec': '[Số Kép] Giảm dần',
            'double_arith_inc': '[Số Kép] Tăng dần ĐỀU',
            'double_arith_dec': '[Số Kép] Giảm dần ĐỀU',
            'offset_double_occur': '[Số Kép Lệch] Về liên tiếp',
            'offset_double_mono_inc': '[Số Kép Lệch] Tăng dần',
            'offset_double_mono_dec': '[Số Kép Lệch] Giảm dần',
            'offset_double_arith_inc': '[Số Kép Lệch] Tăng dần ĐỀU',
            'offset_double_arith_dec': '[Số Kép Lệch] Giảm dần ĐỀU',
            
            'pht_head_even_mono_inc': '[Đầu Chẵn] Tiến dần',
            'pht_head_even_arith_inc': '[Đầu Chẵn] Tiến dần ĐỀU',
            'pht_head_even_mono_dec': '[Đầu Chẵn] Lùi dần',
            'pht_head_even_arith_dec': '[Đầu Chẵn] Lùi dần ĐỀU',
            'pht_head_even_occur': '[Đầu Chẵn] Về liên tiếp',
            'pht_head_odd_mono_inc': '[Đầu Lẻ] Tiến dần',
            'pht_head_odd_arith_inc': '[Đầu Lẻ] Tiến dần ĐỀU',
            'pht_head_odd_mono_dec': '[Đầu Lẻ] Lùi dần',
            'pht_head_odd_arith_dec': '[Đầu Lẻ] Lùi dần ĐỀU',
            'pht_head_odd_occur': '[Đầu Lẻ] Về liên tiếp',
            'pht_tail_even_mono_inc': '[Đít Chẵn] Tiến dần',
            'pht_tail_even_arith_inc': '[Đít Chẵn] Tiến dần ĐỀU',
            'pht_tail_even_mono_dec': '[Đít Chẵn] Lùi dần',
            'pht_tail_even_arith_dec': '[Đít Chẵn] Lùi dần ĐỀU',
            'pht_tail_even_occur': '[Đít Chẵn] Về liên tiếp',
            'pht_tail_odd_mono_inc': '[Đít Lẻ] Tiến dần',
            'pht_tail_odd_arith_inc': '[Đít Lẻ] Tiến dần ĐỀU',
            'pht_tail_odd_mono_dec': '[Đít Lẻ] Lùi dần',
            'pht_tail_odd_arith_dec': '[Đít Lẻ] Lùi dần ĐỀU',
            'pht_tail_odd_occur': '[Đít Lẻ] Về liên tiếp',
            
            // --- ĐẦU TO/NHỎ - ĐÍT TO/NHỎ ---
            'ht_size_bb_occur': '[Đầu To-Đít To] Về liên tiếp',
            'ht_size_bb_mono_inc': '[Đầu To-Đít To] Tăng dần',
            'ht_size_bb_mono_dec': '[Đầu To-Đít To] Giảm dần',
            'ht_size_bb_arith_inc': '[Đầu To-Đít To] Tăng dần ĐỀU',
            'ht_size_bb_arith_dec': '[Đầu To-Đít To] Giảm dần ĐỀU',
            'ht_size_bs_occur': '[Đầu To-Đít Nhỏ] Về liên tiếp',
            'ht_size_bs_mono_inc': '[Đầu To-Đít Nhỏ] Tăng dần',
            'ht_size_bs_mono_dec': '[Đầu To-Đít Nhỏ] Giảm dần',
            'ht_size_bs_arith_inc': '[Đầu To-Đít Nhỏ] Tăng dần ĐỀU',
            'ht_size_bs_arith_dec': '[Đầu To-Đít Nhỏ] Giảm dần ĐỀU',
            'ht_size_sb_occur': '[Đầu Nhỏ-Đít To] Về liên tiếp',
            'ht_size_sb_mono_inc': '[Đầu Nhỏ-Đít To] Tăng dần',
            'ht_size_sb_mono_dec': '[Đầu Nhỏ-Đít To] Giảm dần',
            'ht_size_sb_arith_inc': '[Đầu Nhỏ-Đít To] Tăng dần ĐỀU',
            'ht_size_sb_arith_dec': '[Đầu Nhỏ-Đít To] Giảm dần ĐỀU',
            'ht_size_ss_occur': '[Đầu Nhỏ-Đít Nhỏ] Về liên tiếp',
            'ht_size_ss_mono_inc': '[Đầu Nhỏ-Đít Nhỏ] Tăng dần',
            'ht_size_ss_mono_dec': '[Đầu Nhỏ-Đít Nhỏ] Giảm dần',
            'ht_size_ss_arith_inc': '[Đầu Nhỏ-Đít Nhỏ] Tăng dần ĐỀU',
            'ht_size_ss_arith_dec': '[Đầu Nhỏ-Đít Nhỏ] Giảm dần ĐỀU',
            
            'evenHeadsGreaterThan4': 'Dạng đầu chẵn > 4 về liên tiếp',
            'evenHeadsLessThan4': 'Dạng đầu chẵn < 4 về liên tiếp',
            'evenTailsGreaterThan4': 'Dạng đít chẵn > 4 về liên tiếp',
            'evenTailsLessThan4': 'Dạng đít chẵn < 4 về liên tiếp',
            'oddHeadsGreaterThan5': 'Dạng đầu lẻ > 5 về liên tiếp',
            'oddHeadsLessThan5': 'Dạng đầu lẻ < 5 về liên tiếp',
            'oddTailsGreaterThan5': 'Dạng đít lẻ > 5 về liên tiếp',
            'oddTailsLessThan5': 'Dạng đít lẻ < 5 về liên tiếp',
            'headTail_0101': 'Dạng đầu chẵn > 4 và đít chẵn > 4',
            'headTail_0100': 'Dạng đầu chẵn > 4 và đít chẵn < 4',
            'headTail_0111': 'Dạng đầu chẵn > 4 và đít lẻ > 5',
            'headTail_0110': 'Dạng đầu chẵn > 4 và đít lẻ < 5',
            'headTail_0001': 'Dạng đầu chẵn < 4 và đít chẵn > 4',
            'headTail_0000': 'Dạng đầu chẵn < 4 và đít chẵn < 4',
            'headTail_0011': 'Dạng đầu chẵn < 4 và đít lẻ > 5',
            'headTail_0010': 'Dạng đầu chẵn < 4 và đít lẻ < 5',
            'headTail_1101': 'Dạng đầu lẻ > 5 và đít chẵn > 4',
            'headTail_1100': 'Dạng đầu lẻ > 5 và đít chẵn < 4',
            'headTail_1111': 'Dạng đầu lẻ > 5 và đít lẻ > 5',
            'headTail_1110': 'Dạng đầu lẻ > 5 và đít lẻ < 5',
            'headTail_1001': 'Dạng đầu lẻ < 5 và đít chẵn > 4',
            'headTail_1000': 'Dạng đầu lẻ < 5 và đít chẵn < 4',
            'headTail_1011': 'Dạng đầu lẻ < 5 và đít lẻ > 5',
            'headTail_1010': 'Dạng đầu lẻ < 5 và đít lẻ < 5',
            'headTail_401': 'Dạng đầu 4 và đít chẵn > 4',
            'headTail_400': 'Dạng đầu 4 và đít chẵn < 4',
            'headTail_411': 'Dạng đầu 4 và đít lẻ > 5',
            'headTail_410': 'Dạng đầu 4 và đít lẻ < 5',
            'headTail_501': 'Dạng đầu 5 và đít chẵn > 4',
            'headTail_500': 'Dạng đầu 5 và đít chẵn < 4',
            'headTail_511': 'Dạng đầu 5 và đít lẻ > 5',
            'headTail_510': 'Dạng đầu 5 và đít lẻ < 5',
            'headTail_014': 'Dạng đít 4 và đầu chẵn > 4',
            'headTail_004': 'Dạng đít 4 và đầu chẵn < 4',
            'headTail_114': 'Dạng đít 4 và đầu lẻ > 5',
            'headTail_104': 'Dạng đít 4 và đầu lẻ < 5',
            'headTail_015': 'Dạng đít 5 và đầu chẵn > 4',
            'headTail_005': 'Dạng đít 5 và đầu chẵn < 4',
            'headTail_115': 'Dạng đít 5 và đầu lẻ > 5',
            'headTail_105': 'Dạng đít 5 và đầu lẻ < 5',
            'adv_sum_common_inc_trad': '[Tổng TT] Cùng tổng - Tăng dần',
            'adv_sum_common_dec_trad': '[Tổng TT] Cùng tổng - Giảm dần',
            'adv_sum_common_occur_trad': '[Tổng TT] Cùng tổng - Về liên tiếp',
            'adv_sum_common_inc_new': '[Tổng Mới] Cùng tổng - Tăng dần',
            'adv_sum_common_dec_new': '[Tổng Mới] Cùng tổng - Giảm dần',
            'adv_sum_common_occur_new': '[Tổng Mới] Cùng tổng - Về liên tiếp',
            'adv_sum_common_arith_inc_trad': '[Tổng TT] Cùng tổng - Tăng dần ĐỀU',
            'adv_sum_common_arith_dec_trad': '[Tổng TT] Cùng tổng - Giảm dần ĐỀU',
            'adv_sum_common_arith_inc_new': '[Tổng Mới] Cùng tổng - Tăng dần ĐỀU',
            'adv_sum_common_arith_dec_new': '[Tổng Mới] Cùng tổng - Giảm dần ĐỀU',
            'adv_sum_seq_mono_inc_trad': '[Tổng TT] Các tổng - Tăng dần',
            'adv_sum_seq_mono_dec_trad': '[Tổng TT] Các tổng - Giảm dần',
            'adv_sum_seq_arith_inc_trad': '[Tổng TT] Các tổng - Tăng dần ĐỀU',
            'adv_sum_seq_arith_dec_trad': '[Tổng TT] Các tổng - Giảm dần ĐỀU',
            'adv_sum_seq_occur_trad': '[Tổng TT] Các tổng - Về liên tiếp',
            'adv_sum_seq_mono_inc_new': '[Tổng Mới] Các tổng - Tăng dần',
            'adv_sum_seq_mono_dec_new': '[Tổng Mới] Các tổng - Giảm dần',
            'adv_sum_seq_arith_inc_new': '[Tổng Mới] Các tổng - Tăng dần ĐỀU',
            'adv_sum_seq_arith_dec_new': '[Tổng Mới] Các tổng - Giảm dần ĐỀU',
            'adv_sum_seq_occur_new': '[Tổng Mới] Các tổng - Về liên tiếp',
            'sum_range_trad_1-2': '[Tổng TT] Thống kê tổng (1,2) về liên tiếp',
            'sum_range_trad_3-4': '[Tổng TT] Thống kê tổng (3,4) về liên tiếp',
            'sum_range_trad_5-6': '[Tổng TT] Thống kê tổng (5,6) về liên tiếp',
            'sum_range_trad_7-8': '[Tổng TT] Thống kê tổng (7,8) về liên tiếp',
            'sum_range_trad_9-10': '[Tổng TT] Thống kê tổng (9,10) về liên tiếp',
            'sum_range_new_0-3': '[Tổng Mới] Thống kê tổng (0-3) về liên tiếp',
            'sum_range_new_4-6': '[Tổng Mới] Thống kê tổng (4-6) về liên tiếp',
            'sum_range_new_7-9': '[Tổng Mới] Thống kê tổng (7-9) về liên tiếp ',
            'sum_range_new_10-12': '[Tổng Mới] Thống kê tổng (10-12) về liên tiếp',
            'sum_range_new_13-15': '[Tổng Mới] Thống kê tổng (13-15) về liên tiếp',
            'sum_range_new_16-18': '[Tổng Mới] Thống kê tổng (16-18) về liên tiếp',
            'sum_sole_trad': '[Tổng TT] Thống kê chuỗi tổng sole liên tiếp',
            'sum_sole_new': '[Tổng Mới] Thống kê chuỗi tổng sole liên tiếp',
            'sum_sole_pairs_new': '[Tổng Mới] Các tổng kiểu mới về sole theo cặp',
            // --- TỔNG CHẴN/LẺ (TRUYỀN THỐNG) ---
            'adv_sum_trad_even_mono_inc': '[Tổng TT] Chẵn - Tiến dần',
            'adv_sum_trad_even_arith_inc': '[Tổng TT] Chẵn - Tiến dần ĐỀU',
            'adv_sum_trad_even_mono_dec': '[Tổng TT] Chẵn - Lùi dần',
            'adv_sum_trad_even_arith_dec': '[Tổng TT] Chẵn - Lùi dần ĐỀU',
            'adv_sum_trad_even_occur': '[Tổng TT] Chẵn - Về liên tiếp',
            'adv_sum_trad_odd_mono_inc': '[Tổng TT] Lẻ - Tiến dần',
            'adv_sum_trad_odd_arith_inc': '[Tổng TT] Lẻ - Tiến dần ĐỀU',
            'adv_sum_trad_odd_mono_dec': '[Tổng TT] Lẻ - Lùi dần',
            'adv_sum_trad_odd_arith_dec': '[Tổng TT] Lẻ - Lùi dần ĐỀU',
            'adv_sum_trad_odd_occur': '[Tổng TT] Lẻ - Về liên tiếp',

            // --- TỔNG CHẴN/LẺ (KIỂU MỚI) ---
            'adv_sum_new_even_mono_inc': '[Tổng Mới] Chẵn - Tiến dần',
            'adv_sum_new_even_arith_inc': '[Tổng Mới] Chẵn - Tiến dần ĐỀU',
            'adv_sum_new_even_mono_dec': '[Tổng Mới] Chẵn - Lùi dần',
            'adv_sum_new_even_arith_dec': '[Tổng Mới] Chẵn - Lùi dần ĐỀU',
            'adv_sum_new_even_occur': '[Tổng Mới] Chẵn - Về liên tiếp',
            'adv_sum_new_odd_mono_inc': '[Tổng Mới] Lẻ - Tiến dần',
            'adv_sum_new_odd_arith_inc': '[Tổng Mới] Lẻ - Tiến dần ĐỀU',
            'adv_sum_new_odd_mono_dec': '[Tổng Mới] Lẻ - Lùi dần',
            'adv_sum_new_odd_arith_dec': '[Tổng Mới] Lẻ - Lùi dần ĐỀU',
            'adv_sum_new_odd_occur': '[Tổng Mới] Lẻ - Về liên tiếp',

            // --- DẠNG CỦA TỔNG (0-18, KIỂU MỚI) ---
            'adv_sumpatt_ee_mono_inc': '[Tổng Mới] Chẵn-Chẵn - Tiến dần',
            'adv_sumpatt_ee_arith_inc': '[Tổng Mới] Chẵn-Chẵn - Tiến dần ĐỀU',
            'adv_sumpatt_ee_mono_dec': '[Tổng Mới] Chẵn-Chẵn - Lùi dần',
            'adv_sumpatt_ee_arith_dec': '[Tổng Mới] Chẵn-Chẵn - Lùi dần ĐỀU',
            'adv_sumpatt_ee_occur': '[Tổng Mới] Chẵn-Chẵn - Về liên tiếp',
            'adv_sumpatt_eo_mono_inc': '[Tổng Mới] Chẵn-Lẻ - Tiến dần',
            'adv_sumpatt_eo_arith_inc': '[Tổng Mới] Chẵn-Lẻ - Tiến dần ĐỀU',
            'adv_sumpatt_eo_mono_dec': '[Tổng Mới] Chẵn-Lẻ - Lùi dần',
            'adv_sumpatt_eo_arith_dec': '[Tổng Mới] Chẵn-Lẻ - Lùi dần ĐỀU',
            'adv_sumpatt_eo_occur': '[Tổng Mới] Chẵn-Lẻ - Về liên tiếp',
            'adv_sumpatt_oe_mono_inc': '[Tổng Mới] Lẻ-Chẵn - Tiến dần',
            'adv_sumpatt_oe_arith_inc': '[Tổng Mới] Lẻ-Chẵn - Tiến dần ĐỀU',
            'adv_sumpatt_oe_mono_dec': '[Tổng Mới] Lẻ-Chẵn - Lùi dần',
            'adv_sumpatt_oe_arith_dec': '[Tổng Mới] Lẻ-Chẵn - Lùi dần ĐỀU',
            'adv_sumpatt_oe_occur': '[Tổng Mới] Lẻ-Chẵn - Về liên tiếp',
            'adv_sumpatt_oo_mono_inc': '[Tổng Mới] Lẻ-Lẻ - Tiến dần',
            'adv_sumpatt_oo_arith_inc': '[Tổng Mới] Lẻ-Lẻ - Tiến dần ĐỀU',
            'adv_sumpatt_oo_mono_dec': '[Tổng Mới] Lẻ-Lẻ - Lùi dần',
            'adv_sumpatt_oo_arith_dec': '[Tổng Mới] Lẻ-Lẻ - Lùi dần ĐỀU',
            'adv_sumpatt_oo_occur': '[Tổng Mới] Lẻ-Lẻ - Về liên tiếp',
            
            // --- DẠNG CỦA TỔNG (1-10, TRUYỀN THỐNG) ---
            'adv_sumpatt_trad_ee_mono_inc': '[Tổng TT] Chẵn-Chẵn - Tiến dần',
            'adv_sumpatt_trad_ee_arith_inc': '[Tổng TT] Chẵn-Chẵn - Tiến dần ĐỀU',
            'adv_sumpatt_trad_ee_mono_dec': '[Tổng TT] Chẵn-Chẵn - Lùi dần',
            'adv_sumpatt_trad_ee_arith_dec': '[Tổng TT] Chẵn-Chẵn - Lùi dần ĐỀU',
            'adv_sumpatt_trad_ee_occur': '[Tổng TT] Chẵn-Chẵn - Về liên tiếp',
            'adv_sumpatt_trad_eo_mono_inc': '[Tổng TT] Chẵn-Lẻ - Tiến dần',
            'adv_sumpatt_trad_eo_arith_inc': '[Tổng TT] Chẵn-Lẻ - Tiến dần ĐỀU',
            'adv_sumpatt_trad_eo_mono_dec': '[Tổng TT] Chẵn-Lẻ - Lùi dần',
            'adv_sumpatt_trad_eo_arith_dec': '[Tổng TT] Chẵn-Lẻ - Lùi dần ĐỀU',
            'adv_sumpatt_trad_eo_occur': '[Tổng TT] Chẵn-Lẻ - Về liên tiếp',
            
            'diff_common_occur': '[Cùng Hiệu] Về liên tiếp',
            'diff_common_mono_inc': '[Cùng Hiệu] Tăng dần',
            'diff_common_mono_dec': '[Cùng Hiệu] Giảm dần',
            'diff_common_arith_inc': '[Cùng Hiệu] Tăng dần ĐỀU',
            'diff_common_arith_dec': '[Cùng Hiệu] Giảm dần ĐỀU',
            'diff_seq_mono_inc': '[Các Hiệu] Tăng dần',
            'diff_seq_mono_dec': '[Các Hiệu] Giảm dần',
            'diff_seq_arith_inc': '[Các Hiệu] Tăng dần ĐỀU',
            'diff_seq_arith_dec': '[Các Hiệu] Giảm dần ĐỀU',
            'diff_even_mono_inc': '[Hiệu Chẵn] Tăng dần',
            'diff_even_mono_dec': '[Hiệu Chẵn] Giảm dần',
            'diff_even_arith_inc': '[Hiệu Chẵn] Tăng dần ĐỀU',
            'diff_even_arith_dec': '[Hiệu Chẵn] Giảm dần ĐỀU',
            'diff_even_occur': '[Hiệu Chẵn] Về liên tiếp',
            'diff_odd_mono_inc': '[Hiệu Lẻ] Tăng dần',
            'diff_odd_mono_dec': '[Hiệu Lẻ] Giảm dần',
            'diff_odd_arith_inc': '[Hiệu Lẻ] Tăng dần ĐỀU',
            'diff_odd_arith_dec': '[Hiệu Lẻ] Giảm dần ĐỀU',
            'diff_odd_occur': '[Hiệu Lẻ] Về liên tiếp',
        };

        function formatStatName(name) {
            return statDisplayNames[name] || name;
        }

        // ================================================================
        // LOGIC MỚI VỚI IndexedDB và WEB WORKER
        // ================================================================

        // Module quản lý cache bằng IndexedDB
        const idbCache = {
            db: null,
            dbName: 'LotteryDashboardDB',
            storeName: 'dataCache',
            init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, 1);
                    request.onerror = (event) => reject("Lỗi khi mở IndexedDB.");
                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        resolve();
                    };
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(this.storeName)) {
                            db.createObjectStore(this.storeName);
                        }
                    };
                });
            },
            get(key) {
                return new Promise((resolve, reject) => {
                    if (!this.db) { reject("DB chưa được khởi tạo."); return; }
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.get(key);
                    request.onerror = (event) => reject("Lỗi khi lấy dữ liệu từ cache.");
                    request.onsuccess = (event) => resolve(event.target.result);
                });
            },
            set(key, value) {
                return new Promise((resolve, reject) => {
                    if (!this.db) { reject("DB chưa được khởi tạo."); return; }
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.put(value, key);
                    request.onerror = (event) => reject("Lỗi khi lưu dữ liệu vào cache.");
                    request.onsuccess = (event) => resolve();
                });
            },
            clear(key) {
                return new Promise((resolve, reject) => {
                    if (!this.db) { reject("DB chưa được khởi tạo."); return; }
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.delete(key);
                    request.onerror = (event) => reject("Lỗi khi xóa dữ liệu cache.");
                    request.onsuccess = (event) => resolve();
                });
            }
        };

        const dashboardApp = {
            spinner: document.getElementById('loading-spinner'),
            content: document.getElementById('dashboard-content'),
            errorEl: document.getElementById('error-message'),
            updateButton: document.getElementById('updateDataButton'),
            DASHBOARD_DATA_KEY: 'dashboardData',
            SESSION_UPDATE_KEY: 'sessionUpdateCheck',

            async init() {
                this.updateButton.addEventListener('click', () => this.forceUpdateData(false));
                await idbCache.init();

                const needsUpdate = !sessionStorage.getItem(this.SESSION_UPDATE_KEY);
                if (needsUpdate) {
                    console.log("Phiên làm việc mới, đang tự động cập nhật dữ liệu...");
                    sessionStorage.setItem(this.SESSION_UPDATE_KEY, 'done');
                    // Chạy cập nhật và chờ nó hoàn thành trước khi tải dashboard
                    await this.forceUpdateData(true); 
                } else {
                    console.log("Đã cập nhật trong phiên này, tải dashboard từ cache/fetch.");
                    await this.loadDashboard();
                }

                this.updateLastUpdateDateDisplay();
            },

            async forceUpdateData(isSilent = false) {
                this.updateButton.disabled = true;
                this.updateButton.textContent = 'Đang cập nhật...';
                this.spinner.style.display = 'block'; // Hiển thị spinner khi cập nhật
                this.content.style.display = 'none';

                try {
                    const response = await fetch('/api/update-data', { method: 'POST' });
                    const data = await response.json();
                    if (data.success) {
                        if (!isSilent) alert('Dữ liệu đã được cập nhật! Đang tải lại thống kê nhanh...');
                        await idbCache.clear(this.DASHBOARD_DATA_KEY);
                        await this.fetchAndProcess(); // Fetch dữ liệu mới ngay sau khi cập nhật
                    } else {
                        if (!isSilent) alert('Có lỗi xảy ra khi cập nhật dữ liệu.');
                        this.showError('Cập nhật dữ liệu thất bại.');
                    }
                } catch (error) {
                    if (!isSilent) alert('Có lỗi xảy ra khi cập nhật dữ liệu.');
                    this.showError('Lỗi mạng khi cập nhật dữ liệu.');
                } finally {
                    this.updateButton.disabled = false;
                    this.updateButton.textContent = 'Cập nhật dữ liệu';
                }
            },

            async loadDashboard() {
                this.spinner.style.display = 'block';
                this.content.style.display = 'none';
                try {
                    const cachedData = await idbCache.get(this.DASHBOARD_DATA_KEY);
                    if (cachedData) {
                        console.log("Sử dụng dữ liệu từ cache IndexedDB.");
                        this.processDataWithWorker(cachedData);
                    } else {
                        await this.fetchAndProcess();
                    }
                } catch (e) {
                     this.showError('Có lỗi xảy ra khi tải dashboard.');
                }
            },

            async fetchAndProcess() {
                console.log("Cache rỗng, đang fetch dữ liệu...");
                // Không hiển thị spinner ở đây nữa vì đã hiển thị ở hàm gọi

                return new Promise((resolve, reject) => {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 90000);

                    fetch('/overall-stats', { signal: controller.signal })
                        .then(response => {
                            clearTimeout(timeoutId);
                            return response.ok ? response.json() : Promise.reject(response.statusText);
                        })
                        .then(async (data) => {
                            await idbCache.set(this.DASHBOARD_DATA_KEY, data);
                            console.log("Đã lưu dữ liệu vào cache IndexedDB.");
                            this.processDataWithWorker(data);
                            resolve();
                        })
                        .catch(error => {
                            this.showError(`Không thể tải dữ liệu. (${error})`);
                            reject(error);
                        });
                });
            },

            processDataWithWorker(data) {
                if (window.Worker) {
                    const dashboardWorker = new Worker('/js/dashboardWorker.js');
                    dashboardWorker.onmessage = (event) => {
                        if (event.data.success) {
                            this.renderFromWorker(event.data);
                        } else {
                            this.showError('Lỗi từ Worker: ' + event.data.error);
                        }
                        dashboardWorker.terminate();
                    };
                    dashboardWorker.onerror = (e) => this.showError(`Lỗi Worker: ${e.message}`);
                    dashboardWorker.postMessage({ data: data, names: statDisplayNames });
                } else {
                    // ================================================================
                    // PHƯƠNG ÁN DỰ PHÒNG CHO TRÌNH DUYỆT CŨ
                    // ================================================================
                    console.warn("Trình duyệt không hỗ trợ Web Worker, xử lý trên luồng chính. Giao diện có thể bị treo tạm thời.");

                    try {
                        // Gọi trực tiếp các hàm render (công việc mà worker đáng lẽ phải làm)
                        const longestRunsHtml = renderLongestRuns(data.overallStats, statDisplayNames);
                        const recentStreaksResult = renderRecentStreaks(data.recentStreaks, data.overallStats, statDisplayNames);

                        // Dùng lại hàm renderFromWorker để cập nhật giao diện với dữ liệu đã xử lý
                        this.renderFromWorker({
                            success: true,
                            longestRunsHtml: longestRunsHtml,
                            recentStreaksHtml: recentStreaksResult.html,
                            showNoStreaks: recentStreaksResult.showNoStreaks,
                            latestDate: recentStreaksResult.latestDate
                        });
                    } catch (error) {
                        this.showError('Lỗi khi render dữ liệu trên luồng chính: ' + error.message);
                    }
                }
            },

            renderFromWorker(data) {
                document.getElementById('longest-run-table-body').innerHTML = data.longestRunsHtml;
                const accordionContainer = document.getElementById('recent-streaks-accordion');
                document.getElementById('latest-date-overall').textContent = data.latestDate ? new Date(data.latestDate).toLocaleDateString('vi-VN') : 'N/A';
                accordionContainer.innerHTML = data.recentStreaksHtml;
                document.getElementById('no-streaks-message').style.display = data.showNoStreaks ? 'block' : 'none';
                accordionContainer.style.display = data.showNoStreaks ? 'none' : 'block';

                this.content.style.display = 'block';
                this.errorEl.style.display = 'none';
                this.spinner.style.display = 'none'; // Đảm bảo spinner ẩn đi
            },

            // Hàm hiển thị lỗi
            showError(message) {
                this.errorEl.textContent = message;
                this.errorEl.style.display = 'block';
                this.spinner.style.display = 'none';
                this.content.style.display = 'none';
            },

            // Hàm cập nhật ngày hiển thị
            updateLastUpdateDateDisplay() {
                fetch('/api/last-update-date').then(res => res.json()).then(data => {
                    if (data.lastUpdateDate) {
                        document.getElementById('lastUpdateDate').textContent = formatDate(data.lastUpdateDate);
                    }
                });
            }
        };

        document.addEventListener('DOMContentLoaded', () => dashboardApp.init());
    </script>
</body>
</html>