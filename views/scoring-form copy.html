<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá th·ªëng t√≠nh ƒëi·ªÉm XSMB</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        .nav-item .nav-link {
            font-weight: 500;
            color: #495057;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            margin-right: 5px;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
        }
        .nav-item .nav-link:hover {
            color: #007bff;
            background-color: #e9ecef;
        }
        .nav-item .nav-link.active {
            color: #fff;
            background-color: #007bff;
            border-color: #007bff;
            font-weight: 600;
        }
        .highlight {
            font-weight: bold;
            color: #dc3545;
        }
        .search-options {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            background-color: #f8f9fa;
        }
        .form-option {
            margin-bottom: 1rem;
        }
        .checkbox-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 0.75rem;
            background-color: white;
        }
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 0.5rem;
        }
        .duplicate-highlight {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            margin: 0.25rem 0;
        }
        .duplicate-number-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .duplicate-number-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .form-badge {
            font-size: 0.75rem;
            margin: 2px;
        }
        .table-responsive {
            border-radius: 0.375rem;
            overflow: hidden;
        }
        .table th {
            vertical-align: middle;
            font-weight: 600;
        }
        .table td {
            vertical-align: middle;
        }
        /* Highlight rows based on score */
        .table-danger {
            background-color: rgba(220, 53, 69, 0.1) !important;
        }
        .table-warning {
            background-color: rgba(255, 193, 7, 0.1) !important;
        }
        .table-success {
            background-color: rgba(25, 135, 84, 0.1) !important;
        }
        /* Score styling */
        .fs-5 {
            font-size: 1.25rem !important;
        }
        /* Cards styling */
        .card {
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        /* Sort dropdown styling */
        #sortOrder {
            font-size: 0.9rem;
        }
        /* Highlight sorted column */
        .table th.sorted {
            background-color: #0d6efd !important;
            color: white;
        }
        /* === CSS M·ªöI CHO BI·ªÇU ƒê·ªí NHI·ªÜT === */
        .heatmap-container {
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 0.5rem;
            margin-bottom: 2rem;
        }
        .score-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 5px;
            margin: 0 auto;
            max-width: 600px;
        }
        .heatmap-cell {
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-size: 1rem;
        }
        .heatmap-cell:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .heatmap-legend {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 1rem;
        }
        .legend-item {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 5px;
            border: 1px solid rgba(0,0,0,0.2);
            border-radius: 4px;
        }
        /* Fix text color for certain backgrounds */
        .heatmap-cell.bg-warning {
            color: #333;
        }
        .legend-color.bg-warning {
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">T√≠nh ƒëi·ªÉm XSMB</h1>
        <div class="alert alert-info mt-4 mb-4">
            <p id="dataUpdateNote">D·ªØ li·ªáu XSMB ƒë∆∞·ª£c c·∫≠p nh·∫≠t t·ª´ ng√†y 1/10/2005 ƒë·∫øn ng√†y <span id="lastUpdateDate">AA/BB/CCCC</span></p>
            <button id="updateDataButton" class="btn btn-warning">C·∫≠p nh·∫≠t d·ªØ li·ªáu</button>
        </div>
        <!-- Navigation Menu -->
        <ul class="nav mb-4 justify-content-center" role="tablist">
            <li class="nav-item" role="presentation">
                <a class="nav-link" href="/" role="tab">Th·ªëng k√™</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link active" href="/scoring" role="tab">T√≠nh ƒëi·ªÉm</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" href="/simulation" role="tab">Gi·∫£ L·∫≠p</a>
            </li>
        </ul>
        <form id="scoringForm">
            <div class="row g-3 mb-3">
                <div class="col-md-4">
                    <label for="startDate" class="form-label">Ng√†y b·∫Øt ƒë·∫ßu:</label>
                    <input type="date" class="form-control" id="startDate" name="startDate" min="2005-10-01" required>
                    <small class="text-muted">T·ª± ƒë·ªông t√≠nh t·ª´ ng√†y k·∫øt th√∫c</small>
                </div>
                <div class="col-md-4">
                    <label for="endDate" class="form-label">Ng√†y k·∫øt th√∫c:</label>
                    <input type="date" class="form-control" id="endDate" name="endDate" required>
                    <small class="text-muted" id="dateRangeInfo">Ch·ªçn ng√†y ƒë·ªÉ t√≠nh kho·∫£ng th·ªùi gian</small>
                </div>
                <div class="col-md-4">
                    <label for="mode" class="form-label">Ch·∫ø ƒë·ªô:</label>
                    <select class="form-select" id="mode" name="mode" required>
                        <option value="de">ƒê·ªÅ (Gi·∫£i ƒë·∫∑c bi·ªát)</option>
                        <option value="lo">L√¥ (T·∫•t c·∫£ c√°c gi·∫£i)</option>
                        <option value="prize1">Gi·∫£i nh·∫•t</option>
                        <option value="prize2">Gi·∫£i nh√¨</option>
                        <option value="prize3">Gi·∫£i ba</option>
                        <option value="prize4">Gi·∫£i t∆∞</option>
                        <option value="prize5">Gi·∫£i nƒÉm</option>
                        <option value="prize6">Gi·∫£i s√°u</option>
                        <option value="prize7">Gi·∫£i b·∫£y</option>
                        <option value="pos1">V·ªã tr√≠ 1 (Gi·∫£i nh·∫•t)</option>
                        <option value="pos2">V·ªã tr√≠ 2 (Gi·∫£i nh√¨ 1)</option>
                        <option value="pos3">V·ªã tr√≠ 3 (Gi·∫£i nh√¨ 2)</option>
                        <option value="pos4">V·ªã tr√≠ 4 (Gi·∫£i ba 1)</option>
                        <option value="pos5">V·ªã tr√≠ 5 (Gi·∫£i ba 2)</option>
                        <option value="pos6">V·ªã tr√≠ 6 (Gi·∫£i ba 3)</option>
                        <option value="pos7">V·ªã tr√≠ 7 (Gi·∫£i ba 4)</option>
                        <option value="pos8">V·ªã tr√≠ 8 (Gi·∫£i ba 5)</option>
                        <option value="pos9">V·ªã tr√≠ 9 (Gi·∫£i ba 6)</option>
                        <option value="pos10">V·ªã tr√≠ 10 (Gi·∫£i t∆∞ 1)</option>
                        <option value="pos11">V·ªã tr√≠ 11 (Gi·∫£i t∆∞ 2)</option>
                        <option value="pos12">V·ªã tr√≠ 12 (Gi·∫£i t∆∞ 3)</option>
                        <option value="pos13">V·ªã tr√≠ 13 (Gi·∫£i t∆∞ 4)</option>
                        <option value="pos14">V·ªã tr√≠ 14 (Gi·∫£i nƒÉm 1)</option>
                        <option value="pos15">V·ªã tr√≠ 15 (Gi·∫£i nƒÉm 2)</option>
                        <option value="pos16">V·ªã tr√≠ 16 (Gi·∫£i nƒÉm 3)</option>
                        <option value="pos17">V·ªã tr√≠ 17 (Gi·∫£i nƒÉm 4)</option>
                        <option value="pos18">V·ªã tr√≠ 18 (Gi·∫£i nƒÉm 5)</option>
                        <option value="pos19">V·ªã tr√≠ 19 (Gi·∫£i nƒÉm 6)</option>
                        <option value="pos20">V·ªã tr√≠ 20 (Gi·∫£i s√°u 1)</option>
                        <option value="pos21">V·ªã tr√≠ 21 (Gi·∫£i s√°u 2)</option>
                        <option value="pos22">V·ªã tr√≠ 22 (Gi·∫£i s√°u 3)</option>
                        <option value="pos23">V·ªã tr√≠ 23 (Gi·∫£i b·∫£y 1)</option>
                        <option value="pos24">V·ªã tr√≠ 24 (Gi·∫£i b·∫£y 2)</option>
                        <option value="pos25">V·ªã tr√≠ 25 (Gi·∫£i b·∫£y 3)</option>
                        <option value="pos26">V·ªã tr√≠ 26 (Gi·∫£i b·∫£y 4)</option>
                    </select>
                </div>
            </div>

            <!-- Search Options -->
            <div class="search-options mb-3">
                <label class="form-label fw-bold">Lo·∫°i t√¨m ki·∫øm:</label>
                
                <div class="form-option">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="searchType" id="searchByOccurrence" value="occurrence" checked>
                        <label class="form-check-label" for="searchByOccurrence">
                            T√¨m theo s·ªë l·∫ßn xu·∫•t hi·ªán
                        </label>
                    </div>
                    <div id="occurrenceInput" style="display: block; margin-top: 0.5rem;">
                        <input type="number" class="form-control" id="occurrenceCount" name="occurrenceCount" placeholder="Nh·∫≠p s·ªë l·∫ßn xu·∫•t hi·ªán" min="0">
                    </div>
                </div>

                <div class="form-option">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="searchType" id="searchByForms" value="forms">
                        <label class="form-check-label" for="searchByForms">
                            T√¨m theo d·∫°ng s·ªë c·ª• th·ªÉ
                        </label>
                    </div>
                    <div id="formsSelection" style="display: none; margin-top: 0.5rem;">
                        <div class="checkbox-container">
                            <div class="checkbox-grid" id="checkboxGrid">
                                <!-- Checkboxes will be generated by JavaScript -->
                            </div>
                        </div>
                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" id="selectAllForms">Ch·ªçn t·∫•t c·∫£</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="clearAllForms">B·ªè ch·ªçn t·∫•t c·∫£</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-3 mt-3">
                <button type="submit" class="btn btn-primary">T√¨m ki·∫øm</button>
            </div>
            
            <hr class="my-5" style="border-top: 3px solid #0d6efd;">

            <% if (typeof aggregateResults !== 'undefined' && aggregateResults.length > 0) { %>
                <div class="mt-5">
                    <h2 class="text-center mb-3">B·∫£ng ƒêi·ªÉm T·ªïng H·ª£p C√°c S·ªë (00-99)</h2>
                    <div class="alert alert-primary text-center">
                        Ph√¢n t√≠ch t·ª± ƒë·ªông d·ª±a tr√™n d·ªØ li·ªáu t·ª´ ng√†y <strong><%= aggStartDate %></strong> ƒë·∫øn <strong><%= aggEndDate %></strong> ·ªü ch·∫ø ƒë·ªô <strong><%= aggMode %></strong>.
                    </div>
                    <div class="heatmap-container">
                        <h4 class="text-center mb-4">Bi·ªÉu ƒë·ªì Nhi·ªát ƒêi·ªÉm T·ªïng H·ª£p</h4>
                        <div id="scoreHeatmap" class="score-grid">
                            </div>
                        <div id="heatmapLegend" class="heatmap-legend">
                            </div>
                    </div>
                     <div class="table-responsive">
                        <table class="table table-bordered table-striped table-hover">
                            <thead class="table-dark text-center">
                                <tr>
                                    <th>S·ªë</th>
                                    <th>ƒêi·ªÉm T·ªïng H·ª£p</th>
                                    <th>Tr·∫°ng Th√°i</th>
                                    <th>Chi Ti·∫øt ƒêi·ªÉm</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% aggregateResults.forEach(result => { %>
                                    <tr>
                                        <td class="text-center"><span class="badge bg-primary fs-5"><%= result.number %></span></td>
                                        <td class="text-center"><span class="total-score <%= result.totalScore >= 0 ? 'score-positive' : 'score-negative' %>"><%= result.totalScore %></span></td>
                                        <td class="text-center"><span class="badge <%= result.statusClass %> fs-6"><%= result.status %></span></td>
                                        <td>
                                            <div class="accordion accordion-flush" id="acc-<%= result.number %>">
                                                <div class="accordion-item">
                                                    <h2 class="accordion-header">
                                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#coll-<%= result.number %>">
                                                            Xem <%= result.contributingForms.length %> d·∫°ng ƒë√≥ng g√≥p
                                                        </button>
                                                    </h2>
                                                    <div id="coll-<%= result.number %>" class="accordion-collapse collapse" data-bs-parent="#acc-<%= result.number %>">
                                                        <div class="accordion-body p-2">
                                                            <ul class="list-group list-group-flush">
                                                                <% result.contributingForms.forEach(form => { %>
                                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                                        <div>
                                                                            <small><%= form.formName %></small>
                                                                            <small class="d-block text-muted">Xu·∫•t hi·ªán: <%= form.occurrences %>, HS: <%= form.multiplier %></small>
                                                                        </div>
                                                                        <span class="badge <%= form.score >= 0 ? 'bg-success' : 'bg-danger' %>"><%= Math.round(form.score * 10) / 10 %></span>
                                                                    </li>
                                                                <% }) %>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                </div>
            <% } else { %>
                <div class="alert alert-danger text-center mt-5">Kh√¥ng th·ªÉ t√≠nh to√°n B·∫£ng ƒêi·ªÉm T·ªïng H·ª£p.</div>
            <% } %>
            
            <!-- Sort options dropdown - BACK TO ORIGINAL POSITION -->
            <% if (typeof results !== 'undefined' && results && results.length > 0) { %>
                <div class="row mt-3">
                    <div class="col-12">
                        <label for="sortOrder" class="form-label fw-bold">üìã S·∫Øp x·∫øp k·∫øt qu·∫£:</label>
                        <select class="form-select" id="sortOrder" onchange="sortResults()">
                            <option value="score-asc" selected>ƒêi·ªÉm: Th·∫•p ‚Üí Cao ‚ö†Ô∏è</option>
                            <option value="score-desc">ƒêi·ªÉm: Cao ‚Üí Th·∫•p ‚úÖ</option>
                            <option value="form-asc">D·∫°ng s·ªë: A ‚Üí Z</option>
                            <option value="occurrences-desc">L·∫ßn xu·∫•t hi·ªán: Nhi·ªÅu ‚Üí √çt</option>
                            <option value="occurrences-asc">L·∫ßn xu·∫•t hi·ªán: √çt ‚Üí Nhi·ªÅu</option>
                        </select>
                    </div>
                </div>
            <% } %>
        </form>

        <% if (typeof results !== 'undefined' && results && results.length > 0) { %>
        <div class="mt-5">
            <h3 class="text-center mb-4">K·∫øt qu·∫£ t√≠nh ƒëi·ªÉm</h3>
            
            <!-- Display search info and statistics -->
            <% if (typeof searchType !== 'undefined') { %>
                <% if (searchType === 'all') { %>
                    <p>Hi·ªÉn th·ªã t·∫•t c·∫£ c√°c d·∫°ng s·ªë | T·ªïng s·ªë d·∫°ng: <%= results.length %> | ƒêi·ªÉm t·ªëi ƒëa: 90</p>
                <% } else if (searchType === 'occurrence') { %>
                    <p>T√¨m theo s·ªë l·∫ßn xu·∫•t hi·ªán: <%= occurrenceCount %> | S·ªë d·∫°ng t√¨m th·∫•y: <%= results.length %></p>
                <% } else if (searchType === 'forms') { %>
                    <p>T√¨m theo d·∫°ng s·ªë ƒë√£ ch·ªçn | S·ªë d·∫°ng t√¨m th·∫•y: <%= results.length %></p>
                <% } %>
            <% } else { %>
                <p>ƒêi·ªÉm t·ªëi ƒëa: 90 | C√¥ng th·ª©c t√≠nh ƒëi·ªÉm: 90 - (S·ªë l·∫ßn xu·∫•t hi·ªán √ó H·ªá s·ªë nh√¢n)</p>
                <div class="alert alert-info">
                    <h6>üìä H·ªá s·ªë nh√¢n theo d·∫°ng s·ªë:</h6>
                    <div class="row small">
                        <div class="col-md-6">
                            <strong>D·∫°ng ch√≠nh (25 s·ªë):</strong> x1<br>
                            <strong>D·∫°ng con (4 s·ªë):</strong> x6.25<br>
                            <strong>D·∫°ng con (2 s·ªë):</strong> x12.5<br>
                            <strong>S·ªë ƒë·∫∑c bi·ªát (44,45,54,55):</strong> x30
                        </div>
                        <div class="col-md-6">
                            <strong>Nh√≥m ƒë·∫ßu/ƒë√≠t (8 s·ªë):</strong> x1.25<br>
                            <strong>ƒê·∫ßu/ƒë√≠t ri√™ng l·∫ª (10 s·ªë):</strong> x2.5<br>
                            <strong>S·ªë c·ª• th·ªÉ (00-99):</strong> x15<br>
                            <strong>ƒê√≠t = 4, ƒê√≠t = 5:</strong> x1.25
                        </div>
                    </div>
                </div>
            <% } %>

            <!-- Display scoring statistics -->
            <% 
            const positiveScores = results.filter(r => r.score > 0).length;
            const zeroScores = results.filter(r => r.score === 0).length;
            const negativeScores = results.filter(r => r.score < 0).length;
            const maxScore = Math.max(...results.map(r => r.score));
            const minScore = Math.min(...results.map(r => r.score));
            %>
            
            <div class="alert alert-info">
                <div class="row">
                    <div class="col-md-3">
                        <strong>ƒêi·ªÉm d∆∞∆°ng:</strong> <span class="text-success"><%= positiveScores %></span>
                    </div>
                    <div class="col-md-3">
                        <strong>ƒêi·ªÉm b·∫±ng 0:</strong> <span class="text-warning"><%= zeroScores %></span>
                    </div>
                    <div class="col-md-3">
                        <strong>ƒêi·ªÉm √¢m:</strong> <span class="text-danger"><%= negativeScores %></span>
                    </div>
                    <div class="col-md-3">
                        <strong>Kho·∫£ng ƒëi·ªÉm:</strong> <%= minScore %> ~ <%= maxScore %>
                    </div>
                </div>
            </div>

            <!-- Display duplicate numbers if available -->
            <% if (typeof duplicates !== 'undefined' && duplicates && Object.keys(duplicates).length > 0) { %>
                <div class="alert alert-warning">
                    <h5><i class="bi bi-exclamation-triangle"></i> C√°c s·ªë tr√πng gi·ªØa c√°c d·∫°ng ƒë√£ ch·ªçn:</h5>
                    <p class="mb-3"><small class="text-muted">Nh·ªØng s·ªë n√†y xu·∫•t hi·ªán trong nhi·ªÅu d·∫°ng s·ªë kh√°c nhau, c·∫ßn l∆∞u √Ω khi ph√¢n t√≠ch.</small></p>
                    
                    <div class="row">
                        <% Object.keys(duplicates).sort((a, b) => duplicates[b].length - duplicates[a].length).forEach((number, index) => { %>
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card border-warning duplicate-number-card">
                                    <div class="card-body p-3">
                                        <h6 class="card-title text-warning mb-2">
                                            <strong>S·ªë <%= number %></strong>
                                            <span class="badge bg-warning text-dark ms-2"><%= duplicates[number].length %> d·∫°ng</span>
                                        </h6>
                                        <div class="card-text">
                                            <% duplicates[number].forEach((form, formIndex) => { %>
                                                <span class="badge bg-light text-dark me-1 mb-1 form-badge"><%= form %></span>
                                            <% }) %>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <% }) %>
                    </div>
                    
                    <!-- Summary statistics -->
                    <div class="mt-3 p-3 bg-light rounded">
                        <div class="row text-center">
                            <div class="col-md-4">
                                <strong class="text-primary"><%= Object.keys(duplicates).length %></strong>
                                <br><small>S·ªë tr√πng t·ªïng c·ªông</small>
                            </div>
                            <div class="col-md-4">
                                <strong class="text-warning"><%= Math.max(...Object.values(duplicates).map(forms => forms.length)) %></strong>
                                <br><small>D·∫°ng t·ªëi ƒëa/1 s·ªë</small>
                            </div>
                            <div class="col-md-4">
                                <strong class="text-info"><%= (Object.keys(duplicates).length / results.length * 100).toFixed(1) %>%</strong>
                                <br><small>T·ª∑ l·ªá s·ªë tr√πng</small>
                            </div>
                        </div>
                    </div>
                </div>
            <% } else if (typeof searchType !== 'undefined' && searchType === 'forms') { %>
                <div class="alert alert-success">
                    <h6><i class="bi bi-check-circle"></i> Kh√¥ng c√≥ s·ªë tr√πng</h6>
                    <p class="mb-0"><small>C√°c d·∫°ng s·ªë ƒë√£ ch·ªçn kh√¥ng c√≥ s·ªë n√†o tr√πng nhau.</small></p>
                </div>
            <% } %>
            
            <div class="table-responsive">
                <table class="table table-bordered table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>D·∫°ng s·ªë</th>
                            <th>Ng√†y xu·∫•t hi·ªán</th>
                            <th>H·ªá s·ªë nh√¢n</th>
                            <th>S·ªë l·∫ßn xu·∫•t hi·ªán</th>
                            <th>ƒêi·ªÉm</th>
                            <th>Tr·∫°ng th√°i</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% results.forEach((result, index) => { %>
                            <tr class="<% if (result.score < 0) { %>table-danger<% } else if (result.score === 0) { %>table-warning<% } else if (result.score >= 85) { %>table-success<% } %>">
                                <td>
                                    <strong><%= result.form %></strong>
                                    <% if (result.score < 0) { %>
                                        <br><small class="text-danger">‚ö†Ô∏è Xu·∫•t hi·ªán qu√° nhi·ªÅu</small>
                                    <% } else if (result.score >= 85) { %>
                                        <br><small class="text-success">‚úì √çt xu·∫•t hi·ªán</small>
                                    <% } %>
                                </td>
                                <td>
                                    <% if (result.dates.length > 0) { %>
                                        <div style="max-height: 120px; overflow-y: auto;">
                                            <% result.dates.forEach((date, index) => { %>
                                                <div class="mb-1">
                                                    <small><%= date %>:</small>
                                                    <% if (result.dateToNumbers && result.dateToNumbers[date]) { %>
                                                        <span class="highlight"><%= result.dateToNumbers[date].join(', ') %></span>
                                                    <% } else { %>
                                                        <span class="highlight">N/A</span>
                                                    <% } %>
                                                </div>
                                            <% }) %>
                                        </div>
                                    <% } else { %>
                                        <span class="text-muted">Kh√¥ng xu·∫•t hi·ªán</span>
                                    <% } %>
                                </td>
                                <td>
                                    <span class="badge bg-primary"><%= result.multiplier %></span>
                                </td>
                                <td>
                                    <span class="badge <% if (result.occurrences > 50) { %>bg-danger<% } else if (result.occurrences > 20) { %>bg-warning<% } else { %>bg-success<% } %>">
                                        <%= result.occurrences %>
                                    </span>
                                </td>
                                <td>
                                    <% if (result.score < 0) { %>
                                        <span class="text-danger fw-bold fs-5"><%= result.score %></span>
                                    <% } else if (result.score === 0) { %>
                                        <span class="text-warning fw-bold fs-5"><%= result.score %></span>
                                    <% } else if (result.score >= 85) { %>
                                        <span class="text-success fw-bold fs-5"><%= result.score %></span>
                                    <% } else { %>
                                        <span class="text-primary fw-bold fs-5"><%= result.score %></span>
                                    <% } %>
                                </td>
                                <td>
                                    <% if (result.score < 0) { %>
                                        <span class="badge bg-danger">Qu√° t·∫ßn su·∫•t</span>
                                    <% } else if (result.score === 0) { %>
                                        <span class="badge bg-warning">C√¢n b·∫±ng</span>
                                    <% } else if (result.score >= 85) { %>
                                        <span class="badge bg-success">T·ªët</span>
                                    <% } else if (result.score >= 70) { %>
                                        <span class="badge bg-info">Kh√°</span>
                                    <% } else { %>
                                        <span class="badge bg-secondary">Trung b√¨nh</span>
                                    <% } %>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>

            <!-- Score distribution chart -->
            <div class="mt-4">
                <h5>Ph√¢n b·ªë ƒëi·ªÉm s·ªë</h5>
                <div class="row">
                    <div class="col-md-4">
                        <div class="card text-center border-success">
                            <div class="card-body">
                                <h2 class="text-success"><%= positiveScores %></h2>
                                <p class="card-text">D·∫°ng c√≥ ƒëi·ªÉm d∆∞∆°ng<br><small class="text-muted">(√çt xu·∫•t hi·ªán)</small></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center border-warning">
                            <div class="card-body">
                                <h2 class="text-warning"><%= zeroScores %></h2>
                                <p class="card-text">D·∫°ng c√≥ ƒëi·ªÉm b·∫±ng 0<br><small class="text-muted">(Xu·∫•t hi·ªán ƒë√∫ng m·ª©c)</small></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center border-danger">
                            <div class="card-body">
                                <h2 class="text-danger"><%= negativeScores %></h2>
                                <p class="card-text">D·∫°ng c√≥ ƒëi·ªÉm √¢m<br><small class="text-muted">(Xu·∫•t hi·ªán qu√° nhi·ªÅu)</small></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recommendations based on scores -->
            <% if (negativeScores > 0 || positiveScores > 0) { %>
                <div class="mt-4">
                    <h5>G·ª£i √Ω d·ª± ƒëo√°n</h5>
                    <div class="alert alert-light">
                        <% if (negativeScores > 0) { %>
                            <p><strong class="text-danger">‚ö†Ô∏è C√°c d·∫°ng s·ªë c√≥ ƒëi·ªÉm √¢m:</strong> ƒê√£ xu·∫•t hi·ªán qu√° nhi·ªÅu l·∫ßn, c√≥ th·ªÉ s·∫Ω √≠t xu·∫•t hi·ªán trong th·ªùi gian t·ªõi.</p>
                        <% } %>
                        <% if (positiveScores > 0) { %>
                            <p><strong class="text-success">‚úì C√°c d·∫°ng s·ªë c√≥ ƒëi·ªÉm cao:</strong> Xu·∫•t hi·ªán √≠t, c√≥ th·ªÉ c√≥ c∆° h·ªôi xu·∫•t hi·ªán nhi·ªÅu h∆°n.</p>
                        <% } %>
                        <p><small class="text-muted">*L∆∞u √Ω: ƒê√¢y ch·ªâ l√† ph√¢n t√≠ch th·ªëng k√™, kh√¥ng ƒë·∫£m b·∫£o k·∫øt qu·∫£ trong t∆∞∆°ng lai.</small></p>
                    </div>
                </div>
            <% } %>
        </div>
        <% } else if (typeof message !== 'undefined' && message) { %>
        <div class="alert alert-info mt-4">
            <%= message %>
        </div>
        <% } %>
            
        
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Define multiplier coefficients for each form type - C·∫¨P NH·∫¨T THEO Y√äU C·∫¶U
        const formMultipliers = {
            // Main categories (25 numbers each) - 1x multiplier
            'even-even': 1,
            'even-odd': 1, 
            'odd-odd': 1,
            'odd-even': 1,
            
            // Sub-categories (4 numbers each) - 6.25x multiplier
            '0101': 6.25, // ƒê·∫ßu ch·∫µn >4 ƒê√≠t ch·∫µn >4
            '0000': 6.25, // ƒê·∫ßu ch·∫µn <4 ƒê√≠t ch·∫µn <4
            '0001': 6.25, // ƒê·∫ßu ch·∫µn <4 ƒê√≠t ch·∫µn >4
            '0100': 6.25, // ƒê·∫ßu ch·∫µn >4 ƒê√≠t ch·∫µn <4
            '0111': 6.25, // ƒê·∫ßu ch·∫µn >4 ƒê√≠t l·∫ª >5
            '0010': 6.25, // ƒê·∫ßu ch·∫µn <4 ƒê√≠t l·∫ª <5
            '0011': 6.25, // ƒê·∫ßu ch·∫µn <4 ƒê√≠t l·∫ª >5
            '0110': 6.25, // ƒê·∫ßu ch·∫µn >4 ƒê√≠t l·∫ª <5
            '1111': 6.25, // ƒê·∫ßu l·∫ª >5 ƒê√≠t l·∫ª >5
            '1010': 6.25, // ƒê·∫ßu l·∫ª <5 ƒê√≠t l·∫ª <5
            '1011': 6.25, // ƒê·∫ßu l·∫ª <5 ƒê√≠t l·∫ª >5
            '1110': 6.25, // ƒê·∫ßu l·∫ª >5 ƒê√≠t l·∫ª <5
            '1101': 6.25, // ƒê·∫ßu l·∫ª >5 ƒê√≠t ch·∫µn >4
            '1000': 6.25, // ƒê·∫ßu l·∫ª <5 ƒê√≠t ch·∫µn <4
            '1001': 6.25, // ƒê·∫ßu l·∫ª <5 ƒê√≠t ch·∫µn >4
            '1100': 6.25, // ƒê·∫ßu l·∫ª >5 ƒê√≠t ch·∫µn <4
            
            // Sub-categories (2 numbers each) - 12.5x multiplier
            '400': 12.5,  // ƒê·∫ßu ch·∫µn =4 ƒê√≠t ch·∫µn <4
            '401': 12.5,  // ƒê·∫ßu ch·∫µn =4 ƒê√≠t ch·∫µn >4
            '004': 12.5,  // ƒê√≠t ch·∫µn =4 ƒê·∫ßu ch·∫µn <4
            '014': 12.5,  // ƒê√≠t ch·∫µn =4 ƒê·∫ßu ch·∫µn >4
            '410': 12.5,  // ƒê·∫ßu ch·∫µn =4 ƒê√≠t l·∫ª <5
            '411': 12.5,  // ƒê·∫ßu ch·∫µn =4 ƒê√≠t l·∫ª >5
            '015': 12.5,  // ƒê·∫ßu ch·∫µn >4 ƒê√≠t l·∫ª =5
            '005': 12.5,  // ƒê·∫ßu ch·∫µn <4 ƒê√≠t l·∫ª =5
            '510': 12.5,  // ƒê·∫ßu l·∫ª =5 ƒê√≠t l·∫ª <5
            '511': 12.5,  // ƒê·∫ßu l·∫ª =5 ƒê√≠t l·∫ª >5
            '105': 12.5,  // ƒê√≠t l·∫ª =5 ƒê·∫ßu l·∫ª <5
            '115': 12.5,  // ƒê√≠t l·∫ª =5 ƒê·∫ßu l·∫ª >5
            '500': 12.5,  // ƒê·∫ßu l·∫ª =5 ƒê√≠t ch·∫µn <4
            '501': 12.5,  // ƒê·∫ßu l·∫ª =5 ƒê√≠t ch·∫µn >4
            '114': 12.5,  // ƒê·∫ßu l·∫ª >5 ƒê√≠t ch·∫µn =4
            '104': 12.5,  // ƒê·∫ßu l·∫ª <5 ƒê√≠t ch·∫µn =4
            
            // Specific combinations (1 number each) - 30x multiplier
            '44': 30,     // ƒê·∫ßu ch·∫µn =4, ƒê√≠t ch·∫µn =4
            '45': 30,     // ƒê·∫ßu ch·∫µn =4, ƒê√≠t l·∫ª =5
            '55': 30,     // ƒê·∫ßu l·∫ª =5, ƒê√≠t l·∫ª =5
            '54': 30,     // ƒê·∫ßu l·∫ª =5, ƒê√≠t ch·∫µn =4
            
            // Head/Tail categories (8 numbers each) - 1.25x multiplier
            'head-even-gt4': 1.25, // ƒê·∫ßu ch·∫µn >4
            'tail-even-gt4': 1.25, // ƒê√≠t ch·∫µn >4
            'head-even-lt4': 1.25, // ƒê·∫ßu ch·∫µn <4
            'tail-even-lt4': 1.25, // ƒê√≠t ch·∫µn <4
            'head-odd-lt5': 1.25,  // ƒê·∫ßu l·∫ª <5
            'tail-odd-lt5': 1.25,  // ƒê√≠t l·∫ª <5
            'head-odd-gt5': 1.25,  // ƒê·∫ßu l·∫ª >5
            'tail-odd-gt5': 1.25,  // ƒê√≠t l·∫ª >5
            'tail-4': 1.25,        // ƒê√≠t ch·∫µn = 4
            'tail-5': 1.25,        // ƒê√≠t l·∫ª = 5
            
            // Specific head/tail values (10 numbers each) - 2.5x multiplier
            'head-4': 2.5,  // ƒê·∫ßu =4
            'head-5': 2.5,  // ƒê·∫ßu =5
        };

        // Apply 2.5x multiplier to all individual heads and tails (0-9)
        for (let i = 0; i < 10; i++) {
            formMultipliers[`head-${i}`] = 2.5;
            formMultipliers[`tail-${i}`] = 2.5;
        }

        // Apply 15x multiplier to all individual numbers (00-99)
        for (let i = 0; i < 100; i++) {
            const numStr = String(i).padStart(2, '0');
            formMultipliers[numStr] = 15;
        }

        // Function to get number count for each form type
        function getFormNumberCount(formValue) {
            const countMap = {
                // Main categories
                'even-even': 25, 'even-odd': 25, 'odd-odd': 25, 'odd-even': 25,
                
                // Sub-categories (4 numbers each)
                '0101': 4, '0000': 4, '0001': 4, '0100': 4,
                '0111': 4, '0010': 4, '0011': 4, '0110': 4,
                '1111': 4, '1010': 4, '1011': 4, '1110': 4,
                '1101': 4, '1000': 4, '1001': 4, '1100': 4,
                
                // Sub-categories (2 numbers each)
                '400': 2, '401': 2, '004': 2, '014': 2,
                '410': 2, '411': 2, '015': 2, '005': 2,
                '510': 2, '511': 2, '105': 2, '115': 2,
                '500': 2, '501': 2, '114': 2, '104': 2,
                
                // Specific combinations (1 number each)
                '44': 1, '45': 1, '55': 1, '54': 1,
                
                // Head/Tail categories
                'head-even-gt4': 8, 'tail-even-gt4': 8, 
                'head-even-lt4': 8, 'tail-even-lt4': 8,
                'head-odd-lt5': 8, 'tail-odd-lt5': 8,
                'head-odd-gt5': 8, 'tail-odd-gt5': 8,
                'head-4': 10, 'head-5': 10
            };
            
            // Individual heads and tails (10 each)
            for (let i = 0; i < 10; i++) {
                countMap[`head-${i}`] = 10;
                countMap[`tail-${i}`] = 10;
            }
            
            // Individual numbers (1 each)
            for (let i = 0; i < 100; i++) {
                const numStr = String(i).padStart(2, '0');
                countMap[numStr] = 1;
            }
            
            return countMap[formValue] || 1;
        }

        // Function to get multiplier for a form
        function getFormMultiplier(formValue) {
            return formMultipliers[formValue] || 1;
        }
        const formTypes = [
            // Basic patterns
            { value: 'even-even', description: 'D·∫°ng ch·∫µn ch·∫µn' },
            { value: '0101', description: 'ƒê·∫ßu ch·∫µn >4 ƒê√≠t ch·∫µn >4' },
            { value: '0000', description: 'ƒê·∫ßu ch·∫µn <4 ƒê√≠t ch·∫µn <4' },
            { value: '0001', description: 'ƒê·∫ßu ch·∫µn <4 ƒê√≠t ch·∫µn >4' },
            { value: '0100', description: 'ƒê·∫ßu ch·∫µn >4 ƒê√≠t ch·∫µn <4' },
            { value: '400', description: 'ƒê·∫ßu ch·∫µn =4 ƒê√≠t ch·∫µn <4' },
            { value: '401', description: 'ƒê·∫ßu ch·∫µn =4 ƒê√≠t ch·∫µn >4' },
            { value: '004', description: 'ƒê√≠t ch·∫µn =4 ƒê·∫ßu ch·∫µn <4' },
            { value: '014', description: 'ƒê√≠t ch·∫µn =4 ƒê·∫ßu ch·∫µn >4' },
            { value: '44', description: 'ƒê·∫ßu ch·∫µn =4, ƒê√≠t ch·∫µn =4' },
            
            { value: 'even-odd', description: 'D·∫°ng ch·∫µn l·∫ª' },
            { value: '0111', description: 'ƒê·∫ßu ch·∫µn >4 ƒê√≠t l·∫ª >5' },
            { value: '0010', description: 'ƒê·∫ßu ch·∫µn <4 ƒê√≠t l·∫ª <5' },
            { value: '0011', description: 'ƒê·∫ßu ch·∫µn <4 ƒê√≠t l·∫ª >5' },
            { value: '0110', description: 'ƒê·∫ßu ch·∫µn >4 ƒê√≠t l·∫ª <5' },
            { value: '410', description: 'ƒê·∫ßu ch·∫µn =4 ƒê√≠t l·∫ª <5' },
            { value: '411', description: 'ƒê·∫ßu ch·∫µn =4 ƒê√≠t l·∫ª >5' },
            { value: '015', description: 'ƒê·∫ßu ch·∫µn >4 ƒê√≠t l·∫ª =5' },
            { value: '005', description: 'ƒê·∫ßu ch·∫µn <4 ƒê√≠t l·∫ª =5' },
            { value: '45', description: 'ƒê·∫ßu ch·∫µn =4, ƒê√≠t l·∫ª =5' },
            
            { value: 'odd-odd', description: 'D·∫°ng l·∫ª l·∫ª' },
            { value: '1111', description: 'ƒê·∫ßu l·∫ª >5 ƒê√≠t l·∫ª >5' },
            { value: '1010', description: 'ƒê·∫ßu l·∫ª <5 ƒê√≠t l·∫ª <5' },
            { value: '1011', description: 'ƒê·∫ßu l·∫ª <5 ƒê√≠t l·∫ª >5' },
            { value: '1110', description: 'ƒê·∫ßu l·∫ª >5 ƒê√≠t l·∫ª <5' },
            { value: '510', description: 'ƒê·∫ßu l·∫ª =5 ƒê√≠t l·∫ª <5' },
            { value: '511', description: 'ƒê·∫ßu l·∫ª =5 ƒê√≠t l·∫ª >5' },
            { value: '105', description: 'ƒê√≠t l·∫ª =5 ƒê·∫ßu l·∫ª <5' },
            { value: '115', description: 'ƒê√≠t l·∫ª =5 ƒê·∫ßu l·∫ª >5' },
            { value: '55', description: 'ƒê·∫ßu l·∫ª =5, ƒê√≠t l·∫ª =5' },
            
            { value: 'odd-even', description: 'D·∫°ng l·∫ª ch·∫µn' },
            { value: '1101', description: 'ƒê·∫ßu l·∫ª >5 ƒê√≠t ch·∫µn >4' },
            { value: '1000', description: 'ƒê·∫ßu l·∫ª <5 ƒê√≠t ch·∫µn <4' },
            { value: '1001', description: 'ƒê·∫ßu l·∫ª <5 ƒê√≠t ch·∫µn >4' },
            { value: '1100', description: 'ƒê·∫ßu l·∫ª >5 ƒê√≠t ch·∫µn <4' },
            { value: '500', description: 'ƒê·∫ßu l·∫ª =5 ƒê√≠t ch·∫µn <4' },
            { value: '501', description: 'ƒê·∫ßu l·∫ª =5 ƒê√≠t ch·∫µn >4' },
            { value: '114', description: 'ƒê·∫ßu l·∫ª >5 ƒê√≠t ch·∫µn =4' },
            { value: '104', description: 'ƒê·∫ßu l·∫ª <5 ƒê√≠t ch·∫µn =4' },
            { value: '54', description: 'ƒê·∫ßu l·∫ª =5, ƒê√≠t ch·∫µn =4' },
            
            // Categories (excluding individual numbers that are already defined above)
            { value: 'head-even-gt4', description: 'ƒê·∫ßu ch·∫µn l·ªõn h∆°n 4' },
            { value: 'tail-even-gt4', description: 'ƒê√≠t ch·∫µn l·ªõn h∆°n 4' },
            { value: 'head-even-lt4', description: 'ƒê·∫ßu ch·∫µn b√© h∆°n 4' },
            { value: 'tail-even-lt4', description: 'ƒê√≠t ch·∫µn b√© h∆°n 4' },
            { value: 'head-4', description: 'ƒê·∫ßu = 4' },
            { value: 'head-5', description: 'ƒê·∫ßu = 5' },
            { value: 'head-odd-lt5', description: 'ƒê·∫ßu l·∫ª b√© h∆°n 5' },
            { value: 'tail-odd-lt5', description: 'ƒê√≠t l·∫ª b√© h∆°n 5' },
            { value: 'head-odd-gt5', description: 'ƒê·∫ßu l·∫ª l·ªõn h∆°n 5' },
            { value: 'tail-odd-gt5', description: 'ƒê√≠t l·∫ª l·ªõn h∆°n 5' },
        ];

        // Add individual heads (0-9) - excluding 4 and 5 to avoid duplication
        for (let i = 0; i < 10; i++) {
            if (i !== 4 && i !== 5) {
                formTypes.push({ value: `head-${i}`, description: `ƒê·∫ßu ${i}` });
            }
        }

        // Add individual tails (0-9) - excluding 4 and 5 to avoid duplication
        for (let i = 0; i < 10; i++) {
            if (i !== 4 && i !== 5) {
                formTypes.push({ value: `tail-${i}`, description: `ƒê√≠t ${i}` });
            }
        }

        // Add individual numbers (00-99) - excluding those already defined as specific combinations
        const excludeNumbers = ['44', '45', '54', '55']; // These are already defined above
        for (let i = 0; i < 100; i++) {
            const numStr = String(i).padStart(2, '0');
            if (!excludeNumbers.includes(numStr)) {
                formTypes.push({ value: numStr, description: `S·ªë ${numStr}` });
            }
        }

        // Function to generate checkboxes
        function generateCheckboxes() {
            const grid = document.getElementById('checkboxGrid');
            if (!grid) return;
            
            grid.innerHTML = ''; // Clear existing content
            
            // Sort formTypes for better organization
            const sortedFormTypes = [...formTypes].sort((a, b) => {
                // Prioritize main categories first
                const mainCategories = ['even-even', 'even-odd', 'odd-odd', 'odd-even'];
                const aIsMain = mainCategories.includes(a.value);
                const bIsMain = mainCategories.includes(b.value);
                
                if (aIsMain && !bIsMain) return -1;
                if (!aIsMain && bIsMain) return 1;
                
                // Then sort by description
                return a.description.localeCompare(b.description, 'vi');
            });
            
            sortedFormTypes.forEach((form, index) => {
                const div = document.createElement('div');
                div.className = 'form-check';
                
                // Create safe ID by replacing special characters and adding index to ensure uniqueness
                const safeId = `form_${form.value.replace(/[^a-zA-Z0-9]/g, '_')}_${index}`;
                
                div.innerHTML = `
                    <input class="form-check-input" type="checkbox" value="${form.value}" id="${safeId}" data-form-value="${form.value}">
                    <label class="form-check-label" for="${safeId}">${form.description}</label>
                `;
                
                grid.appendChild(div);
            });
            
            console.log(`Generated ${sortedFormTypes.length} checkboxes total`);
        }

        // Enhanced restore function with better logging and reliability
        function restoreCheckboxState(selectedFormsParam) {
            if (!selectedFormsParam) {
                console.log('No selected forms to restore');
                return;
            }
            
            const selectedForms = selectedFormsParam.split(',').map(form => form.trim());
            console.log('Restoring checkboxes for:', selectedForms);
            
            let restoredCount = 0;
            let notFoundCount = 0;
            
            selectedForms.forEach(form => {
                // Try multiple methods to find the checkbox
                let checkbox = null;
                
                // Method 1: Find by data-form-value attribute (most reliable)
                checkbox = document.querySelector(`#checkboxGrid input[data-form-value="${form}"]`);
                
                // Method 2: Find by value attribute as fallback
                if (!checkbox) {
                    checkbox = document.querySelector(`#checkboxGrid input[value="${form}"]`);
                }
                
                // Method 3: Find by checking all checkboxes manually
                if (!checkbox) {
                    const allCheckboxes = document.querySelectorAll('#checkboxGrid input[type="checkbox"]');
                    for (let cb of allCheckboxes) {
                        if (cb.value === form || cb.getAttribute('data-form-value') === form) {
                            checkbox = cb;
                            break;
                        }
                    }
                }
                
                if (checkbox) {
                    checkbox.checked = true;
                    restoredCount++;
                    console.log(`‚úì Restored: ${form}`);
                } else {
                    notFoundCount++;
                    console.warn(`‚úó Checkbox not found for form: ${form}`);
                    
                    // Debug: List all available form values
                    const availableForms = Array.from(document.querySelectorAll('#checkboxGrid input[type="checkbox"]'))
                        .map(cb => cb.value || cb.getAttribute('data-form-value'))
                        .filter(Boolean);
                    console.log('Available forms:', availableForms.slice(0, 10)); // Show first 10 for debugging
                }
            });
            
            console.log(`Restore summary: ${restoredCount} restored, ${notFoundCount} not found out of ${selectedForms.length} total`);
            
            // Update the forms selection display if any checkboxes were restored
            if (restoredCount > 0) {
                const searchTypeRadio = document.querySelector('input[name="searchType"][value="forms"]');
                if (searchTypeRadio && !searchTypeRadio.checked) {
                    searchTypeRadio.checked = true;
                    document.getElementById('formsSelection').style.display = 'block';
                }
            }
        }

        // Search type change handlers
        document.querySelectorAll('input[name="searchType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const occurrenceInput = document.getElementById('occurrenceInput');
                const formsSelection = document.getElementById('formsSelection');
                
                // Hide all option-specific inputs
                occurrenceInput.style.display = 'none';
                formsSelection.style.display = 'none';
                
                // Show relevant input based on selection
                if (this.value === 'occurrence') {
                    occurrenceInput.style.display = 'block';
                } else if (this.value === 'forms') {
                    formsSelection.style.display = 'block';
                }
            });
        });

        // Select/Clear all forms functions
        function setupFormButtons() {
            const selectAllBtn = document.getElementById('selectAllForms');
            const clearAllBtn = document.getElementById('clearAllForms');
            
            if (selectAllBtn) {
                selectAllBtn.addEventListener('click', function() {
                    document.querySelectorAll('#checkboxGrid input[type="checkbox"]').forEach(checkbox => {
                        checkbox.checked = true;
                    });
                });
            }

            if (clearAllBtn) {
                clearAllBtn.addEventListener('click', function() {
                    document.querySelectorAll('#checkboxGrid input[type="checkbox"]').forEach(checkbox => {
                        checkbox.checked = false;
                    });
                });
            }
        }

        // Function to sort results table - S·ª¨A L·∫†I LOGIC S·∫ÆP X·∫æP
        function sortResults() {
            const sortOrder = document.getElementById('sortOrder').value;
            const tableBody = document.querySelector('table tbody');
            
            if (!tableBody) return; // No results table found
            
            const rows = Array.from(tableBody.querySelectorAll('tr'));
            
            rows.sort((a, b) => {
                switch (sortOrder) {
                    case 'score-asc':
                        // Sort by score: Low to High - S·ª¨A: c·ªôt ƒëi·ªÉm l√† c·ªôt th·ª© 4 (index 4)
                        const scoreTextA = a.cells[4].querySelector('span').textContent.trim();
                        const scoreTextB = b.cells[4].querySelector('span').textContent.trim();
                        const scoreA = parseFloat(scoreTextA);
                        const scoreB = parseFloat(scoreTextB);
                        return scoreA - scoreB;
                        
                    case 'score-desc':
                        // Sort by score: High to Low - S·ª¨A: c·ªôt ƒëi·ªÉm l√† c·ªôt th·ª© 4 (index 4)
                        const scoreTextA2 = a.cells[4].querySelector('span').textContent.trim();
                        const scoreTextB2 = b.cells[4].querySelector('span').textContent.trim();
                        const scoreA2 = parseFloat(scoreTextA2);
                        const scoreB2 = parseFloat(scoreTextB2);
                        return scoreB2 - scoreA2;
                        
                    case 'form-asc':
                        // Sort by form name: A to Z - S·ª¨A: c·ªôt d·∫°ng s·ªë l√† c·ªôt ƒë·∫ßu ti√™n (index 0)
                        const formA = a.cells[0].querySelector('strong').textContent.trim();
                        const formB = b.cells[0].querySelector('strong').textContent.trim();
                        return formA.localeCompare(formB, 'vi');
                        
                    case 'occurrences-desc':
                        // Sort by occurrences: High to Low - S·ª¨A: c·ªôt s·ªë l·∫ßn xu·∫•t hi·ªán l√† c·ªôt th·ª© 3 (index 3)
                        const occTextA = a.cells[3].querySelector('span.badge').textContent.trim();
                        const occTextB = b.cells[3].querySelector('span.badge').textContent.trim();
                        const occA = parseInt(occTextA);
                        const occB = parseInt(occTextB);
                        return occB - occA;
                        
                    case 'occurrences-asc':
                        // Sort by occurrences: Low to High - S·ª¨A: c·ªôt s·ªë l·∫ßn xu·∫•t hi·ªán l√† c·ªôt th·ª© 3 (index 3)
                        const occTextA2 = a.cells[3].querySelector('span.badge').textContent.trim();
                        const occTextB2 = b.cells[3].querySelector('span.badge').textContent.trim();
                        const occA2 = parseInt(occTextA2);
                        const occB2 = parseInt(occTextB2);
                        return occA2 - occB2;
                        
                    default:
                        return 0;
                }
            });
            
            // Clear table body and append sorted rows
            tableBody.innerHTML = '';
            rows.forEach((row) => {
                tableBody.appendChild(row);
            });
            
            // Update row highlighting after sorting
            updateRowHighlighting();
            
            // Update URL with current sort order
            updateURLWithSortOrder(sortOrder);
        }
        
        // Function to update URL with sort order without reloading page
        function updateURLWithSortOrder(sortOrder) {
            const currentUrl = new URL(window.location);
            currentUrl.searchParams.set('sortOrder', sortOrder);
            
            // Update URL without reloading the page
            window.history.replaceState({}, '', currentUrl);
        }
        
        // Function to update row highlighting based on scores
        function updateRowHighlighting() {
            const rows = document.querySelectorAll('table tbody tr');
            rows.forEach(row => {
                // S·ª¨A: c·ªôt ƒëi·ªÉm l√† c·ªôt th·ª© 4 (index 4)
                const scoreText = row.cells[4].querySelector('span').textContent.trim();
                const score = parseFloat(scoreText);
                
                // Remove existing classes
                row.classList.remove('table-danger', 'table-warning', 'table-success');
                
                // Add appropriate class based on score
                if (score < 0) {
                    row.classList.add('table-danger');
                } else if (score === 0) {
                    row.classList.add('table-warning');
                } else if (score >= 85) {
                    row.classList.add('table-success');
                }
            });
        }
        
        // Form submission handler
        document.getElementById('scoringForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const searchType = formData.get('searchType');
            
            let url = '/scoring?';
            const params = new URLSearchParams();
            
            // Add basic parameters
            params.append('startDate', formData.get('startDate'));
            params.append('endDate', formData.get('endDate'));
            params.append('mode', formData.get('mode'));
            params.append('searchType', searchType);
            
            // Add sort order parameter if there are results
            const sortOrderElement = document.getElementById('sortOrder');
            if (sortOrderElement) {
                params.append('sortOrder', sortOrderElement.value);
            }
            
            if (searchType === 'occurrence') {
                const occurrenceCount = formData.get('occurrenceCount');
                if (!occurrenceCount || occurrenceCount.trim() === '') {
                    alert('Vui l√≤ng nh·∫≠p s·ªë l·∫ßn xu·∫•t hi·ªán');
                    return;
                }
                if (parseInt(occurrenceCount) < 0) {
                    alert('S·ªë l·∫ßn xu·∫•t hi·ªán ph·∫£i l·ªõn h∆°n ho·∫∑c b·∫±ng 0');
                    return;
                }
                params.append('occurrenceCount', occurrenceCount);
            } else if (searchType === 'forms') {
                const selectedForms = [];
                document.querySelectorAll('#checkboxGrid input[type="checkbox"]:checked').forEach(checkbox => {
                    selectedForms.push(checkbox.getAttribute('data-form-value') || checkbox.value);
                });
                
                if (selectedForms.length === 0) {
                    alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt d·∫°ng s·ªë');
                    return;
                }
                
                params.append('selectedForms', selectedForms.join(','));
            }
            
            window.location.href = url + params.toString();
        });

        // Utility functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // Update end date handler - auto calculate start date (UPDATED LOGIC FROM INDEX.HTML)
        document.getElementById('endDate').addEventListener('change', function () {
            const endDateValue = this.value;
            if (endDateValue) {
                const endDate = new Date(endDateValue);
                const startDate = new Date(endDate);
                startDate.setDate(endDate.getDate() - 359); // Changed from 360 to 359
                
                // Check if start date is before the minimum allowed date
                const today = new Date();
                const todayFormatted = today.toISOString().split('T')[0];
                const startDateFormatted = startDate.toISOString().split('T')[0];
                
                document.getElementById('startDate').value = startDateFormatted;
                
                // If start date is in the future, set it to today
                if (startDate > today) {
                    document.getElementById('startDate').value = todayFormatted;
                }
                
                // Update date range info
                updateDateRangeInfo();
            }
        });

        // Date range info update function
        function updateDateRangeInfo() {
            const startDateValue = document.getElementById('startDate').value;
            const endDateValue = document.getElementById('endDate').value;
            const dateRangeInfo = document.getElementById('dateRangeInfo');
            
            if (startDateValue && endDateValue) {
                const startDate = new Date(startDateValue);
                const endDate = new Date(endDateValue);
                const daysDifference = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                
                if (daysDifference > 0) {
                    dateRangeInfo.textContent = `Kho·∫£ng: ${daysDifference} ng√†y`;
                    dateRangeInfo.className = 'text-success';
                    
                    if (daysDifference > 1000) {
                        dateRangeInfo.textContent += ' (nhi·ªÅu d·ªØ li·ªáu)';
                        dateRangeInfo.className = 'text-warning';
                    }
                } else {
                    dateRangeInfo.textContent = 'Ng√†y kh√¥ng h·ª£p l·ªá';
                    dateRangeInfo.className = 'text-danger';
                }
            } else {
                dateRangeInfo.textContent = 'Ch·ªçn ng√†y ƒë·ªÉ t√≠nh kho·∫£ng th·ªùi gian';
                dateRangeInfo.className = 'text-muted';
            }
        }

        // Update last update date
        function updateLastUpdateDate() {
            fetch('/api/last-update-date')
                .then(response => response.json())
                .then(data => {
                    const lastUpdateDateElement = document.getElementById('lastUpdateDate');
                    if (data.lastUpdateDate) {
                        const formattedDate = formatDate(data.lastUpdateDate);
                        lastUpdateDateElement.textContent = formattedDate;
                    } else {
                        lastUpdateDateElement.textContent = 'Kh√¥ng c√≥ d·ªØ li·ªáu';
                    }
                })
                .catch(error => {
                    console.error('L·ªói khi l·∫•y ng√†y c·∫≠p nh·∫≠t:', error);
                });
        }

        // Update data
        function updateData() {
            fetch('/api/update-data', {
                method: 'POST',
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng!');
                    updateLastUpdateDate();
                } else {
                    alert('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t d·ªØ li·ªáu.');
                }
            })
            .catch(error => {
                console.error('L·ªói khi c·∫≠p nh·∫≠t d·ªØ li·ªáu:', error);
                alert('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t d·ªØ li·ªáu.');
            });
        }

        // DOM Content Loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Generate checkboxes first
            generateCheckboxes();
            
            // Setup form buttons
            setupFormButtons();
            
            // Update last update date
            updateLastUpdateDate();
            
            // Update data button handler
            document.getElementById('updateDataButton').addEventListener('click', function () {
                updateData();
            });

            // Set default dates (UPDATED LOGIC FROM INDEX.HTML)
            const today = new Date().toISOString().split('T')[0];
            const defaultStartDate = new Date();
            defaultStartDate.setDate(defaultStartDate.getDate() - 359); // Changed from 360 to 359
            const formattedStartDate = defaultStartDate.toISOString().split('T')[0];
            
            // Get URL parameters
            const startDateParam = getUrlParameter('startDate');
            const endDateParam = getUrlParameter('endDate');
            const modeParam = getUrlParameter('mode');
            const searchTypeParam = getUrlParameter('searchType');
            const occurrenceCountParam = getUrlParameter('occurrenceCount');
            const selectedFormsParam = getUrlParameter('selectedForms');
            const sortOrderParam = getUrlParameter('sortOrder'); // Th√™m parameter sort order
            
            // Set form values from URL parameters or defaults
            if (!document.getElementById('startDate').value) {
                document.getElementById('startDate').value = startDateParam || formattedStartDate;
            }
            
            if (!document.getElementById('endDate').value) {
                document.getElementById('endDate').value = endDateParam || today;
            }
            
            if (modeParam) {
                document.getElementById('mode').value = modeParam;
            }
            
            // Set search type and restore form state
            if (searchTypeParam) {
                const radioButton = document.querySelector(`input[name="searchType"][value="${searchTypeParam}"]`);
                if (radioButton) {
                    radioButton.checked = true;
                    
                    if (searchTypeParam === 'occurrence') {
                        document.getElementById('occurrenceInput').style.display = 'block';
                        document.getElementById('formsSelection').style.display = 'none';
                        if (occurrenceCountParam) {
                            document.getElementById('occurrenceCount').value = occurrenceCountParam;
                        }
                    } else if (searchTypeParam === 'forms') {
                        document.getElementById('formsSelection').style.display = 'block';
                        document.getElementById('occurrenceInput').style.display = 'none';
                        
                        // Restore checkbox state with multiple attempts and longer delays
                        if (selectedFormsParam) {
                            console.log('Starting checkbox restoration process...');
                            
                            // Try immediately
                            restoreCheckboxState(selectedFormsParam);
                            
                            // Try again after 100ms (DOM might not be fully ready)
                            setTimeout(() => {
                                console.log('Retry 1: Attempting checkbox restoration...');
                                restoreCheckboxState(selectedFormsParam);
                            }, 100);
                            
                            // Final attempt after 500ms
                            setTimeout(() => {
                                console.log('Retry 2: Final attempt at checkbox restoration...');
                                restoreCheckboxState(selectedFormsParam);
                            }, 500);
                        }
                    }
                }
            } else {
                // Default state: show occurrence input, hide forms selection
                document.getElementById('occurrenceInput').style.display = 'block';
                document.getElementById('formsSelection').style.display = 'none';
            }

            // Set active tab based on current path
            const currentPath = window.location.pathname;
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === currentPath) {
                    link.classList.add('active');
                }
            });
            
            // Initial date range info update
            updateDateRangeInfo();
            
            // Auto-sort results by score (low to high) if results table exists
            const resultsTable = document.querySelector('table tbody');
            if (resultsTable && resultsTable.children.length > 0) {
                const sortOrderDropdown = document.getElementById('sortOrder');
                if (sortOrderDropdown) {
                    // Set sort order from URL parameter or default to score ascending
                    if (sortOrderParam && sortOrderParam !== '') {
                        sortOrderDropdown.value = sortOrderParam;
                    } else {
                        sortOrderDropdown.value = 'score-asc';
                    }
                    
                    // Apply the sorting
                    setTimeout(() => {
                        sortResults();
                    }, 100);
                }
            }
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // D·ªØ li·ªáu ƒë∆∞·ª£c nh√∫ng t·ª´ controller
            const aggregateData = <%- JSON.stringify(aggregateResults || []) %>;

            if (aggregateData && aggregateData.length > 0) {
                const heatmapContainer = document.getElementById('scoreHeatmap');
                const legendContainer = document.getElementById('heatmapLegend');

                // T·∫°o m·ªôt map ƒë·ªÉ tra c·ª©u nhanh th√¥ng tin c·ªßa s·ªë
                const resultsMap = new Map(aggregateData.map(item => [item.number, {
                    class: item.statusClass,
                    score: item.totalScore
                }]));
                
                // T·∫°o l∆∞·ªõi 10x10
                for (let i = 0; i < 100; i++) {
                    const numberStr = String(i).padStart(2, '0');
                    const cell = document.createElement('div');
                    const result = resultsMap.get(numberStr);
                    
                    cell.textContent = numberStr;
                    cell.classList.add('heatmap-cell');

                    if (result) {
                        // √Åp d·ª•ng class m√†u t·ª´ d·ªØ li·ªáu (v√≠ d·ª•: 'bg-success', 'bg-danger')
                        cell.classList.add(...result.class.split(' '));
                        // Th√™m tooltip hi·ªÉn th·ªã ƒëi·ªÉm s·ªë chi ti·∫øt
                        cell.title = `S·ªë ${numberStr} | ƒêi·ªÉm: ${result.score}`;
                    } else {
                        cell.classList.add('bg-light', 'text-muted');
                        cell.title = `S·ªë ${numberStr} | Kh√¥ng c√≥ d·ªØ li·ªáu`;
                    }
                    heatmapContainer.appendChild(cell);
                }

                // T·∫°o ch√∫ gi·∫£i (legend)
                const legendData = [
                    { label: 'Kh√°', class: 'bg-success' },
                    { label: 'Trung B√¨nh', class: 'bg-info' },
                    { label: 'C√¢n B·∫±ng', class: 'bg-secondary' },
                    { label: 'K√©m', class: 'bg-warning text-dark' },
                    { label: 'R·∫•t K√©m', class: 'bg-danger' }
                ];

                legendData.forEach(item => {
                    const legendItem = document.createElement('div');
                    legendItem.className = 'legend-item';

                    const colorBox = document.createElement('div');
                    colorBox.className = 'legend-color';
                    colorBox.classList.add(...item.class.split(' '));
                    
                    const label = document.createElement('span');
                    label.textContent = item.label;

                    legendItem.appendChild(colorBox);
                    legendItem.appendChild(label);
                    legendContainer.appendChild(legendItem);
                });
            }
        });
    </script>
</body>
</html>